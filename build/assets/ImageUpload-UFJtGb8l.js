import{r,j as o,li as le,s as m,bH as ce,c1 as ee,T as D,f as de,cO as oe,cx as pe,av as ue,lj as ge,u as te,lk as ae,o as se,ll as O,co as ne,lm as me,ln as ie,hp as he,m as ye,ao as fe,bp as be,dw as xe,dx as Ce,ba as Ie,q as ve,fh as Te,ak as De,af as Se,ag as we,aa as Le,ad as W,bB as K,cQ as Ee,dB as je,a1 as re,lo as ke,dD as Ae}from"./index-Eksrs3uK.js";import{C as Ue}from"./CopyTooltip-mIyzAQ7E.js";import{P as Fe}from"./Prompt-hwoFL8xF.js";import{a as Re,R as Pe}from"./RegionSelect-_Z8IGlox.js";import{c as ze,d as Be,M as Oe,p as X,u as Me,F as _e,o as Ne,a as V}from"./ObjectUploader-HVL1-uVl.js";import"./index-Y5esPPk-.js";import"./Autocomplete-XvrzKoAo.js";import"./Flag-kVTQNGw3.js";import"./ListItem-joIHQeyv.js";import"./visuallyHidden-DVicuktI.js";import"./immer.esm--MpJ8fpr.js";const He=r.memo(e=>{const{analyticsKey:a,command:l,isOpen:u,onClose:c}=e;return o.jsx(qe,{fullWidth:!0,onClose:c,open:u,title:"Upload Image with the Linode CLI",children:o.jsxs($e,{children:[o.jsx(Qe,{children:l})," ",o.jsx(Ge,{onClickCallback:a?()=>le(a):void 0,text:l})]})})}),qe=m(ce,{label:"StyledLinodeCLIModal"})(({theme:e})=>({"& [data-qa-copied]":{zIndex:2},padding:`${e.spacing()} ${e.spacing(2)}`,width:"100%"})),$e=m("div",{label:"StyledCommandDisplay"})(({theme:e})=>({alignItems:"center",backgroundColor:e.bg.main,border:`1px solid ${e.color.border2}`,display:"flex",fontFamily:'"UbuntuMono", monospace, sans-serif',fontSize:"0.875rem",justifyContent:"space-between",lineHeight:1,padding:e.spacing(),position:"relative",whiteSpace:"nowrap",width:"100%",wordBreak:"break-all"})),Qe=m("div",{label:"StyledCLIText"})(()=>({height:"1rem",overflowX:"auto",overflowY:"hidden",paddingRight:15})),Ge=m(Ue,{label:"StyledCopyTooltip"})(()=>({"& svg":{height:"1em",width:"1em"},display:"flex"})),Ze=m("div",{label:"StyledDropZoneDiv",shouldForwardProp:ee(["dropzoneDisabled","isDragActive","isDragAccept","isDragReject"])})(({theme:e,...a})=>({backgroundColor:"transparent",borderColor:e.palette.primary.main,borderStyle:"dashed",borderWidth:1,color:e.palette.primary.main,display:"flex",flexDirection:"row",height:"100%",justifyContent:"space-between",marginTop:e.spacing(2),maxHeight:400,minHeight:140,outline:"none",overflow:"auto",padding:e.spacing(),position:"relative",transition:e.transitions.create(["background-color","border-color"]),...a.isDragActive&&{backgroundColor:e.color.white,borderColor:e.palette.primary.light},...a.isDragAccept&&{borderColor:e.palette.primary.light},...a.isDragReject&&{borderColor:e.color.red},...a.dropzoneDisabled&&{borderColor:"#888"}})),We=m("div",{label:"StyledFileUploadsDiv"})({display:"flex",flexDirection:"column",flexGrow:1,justifyContent:"flex-start"}),Ye=m("div",{label:"StyledDropZoneContentDiv",shouldForwardProp:ee(["uploadZoneActive"])})(({theme:e,...a})=>({alignItems:"center",display:"flex",flexDirection:"column",justifyContent:"center",padding:e.spacing(2),textAlign:"center",width:"100%",...a.uploadZoneActive&&{backgroundColor:"transparent",bottom:e.spacing(1.5),padding:0,position:"absolute",width:`calc(100% - ${e.spacing(4)})`,zIndex:10}})),Ke=m(D,{label:"StyledCopy"})(({theme:e})=>({color:e.palette.text.primary,margin:"0 auto"})),Xe=m(de,{label:"StyledUploadButton"})(({theme:e})=>({marginTop:e.spacing(2),opacity:1,transition:e.transitions.create(["opacity"])})),Ve=oe.create({}),Je="application/octet-stream",J=(e,a,l)=>{const c=oe.CancelToken.source(),h={cancelToken:c.token,data:a,headers:{"Content-Type":Je},method:"PUT",onUploadProgress:l,url:e};return{cancel:c.cancel,request:()=>Ve.request(h)}},eo=r.memo(e=>{const{apiError:a,description:l,dropzoneDisabled:u,isCloudInit:c,label:h,onSuccess:y,region:C,setErrors:S}=e,{enqueueSnackbar:I}=pe(),[E,f]=r.useState(""),j=ue(),{mutateAsync:M}=ge({cloud_init:c||void 0,description:l||void 0,label:h,region:C}),_=te(),N=ae(),[i,d]=r.useReducer(ze,Be),g=se();r.useEffect(()=>{const t=s=>{s.preventDefault()};return window.addEventListener("dragover",t),window.addEventListener("drop",t),()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",t)}},[]);const H=t=>{const s="";i.numErrors>0&&d({type:"CLEAR_UPLOAD_HISTORY"}),d({files:t,prefix:s,type:"ENQUEUE"})},q=t=>{const s=!t[0].file.type.match(/gzip/gi),p="Only raw disk images (.img) compressed using gzip (.gz) can be uploaded.",v=t.length>1,T="Only one file may be uploaded at a time.",x=`Max file size (${ne(V).formatted}) exceeded`;s?I(p,{autoHideDuration:1e4,variant:"error"}):v?I(T,{autoHideDuration:1e4,variant:"error"}):I(x,{autoHideDuration:1e4,variant:"error"})},w=r.useMemo(()=>i.numQueued===0||i.numInProgress>0?[]:i.files.filter(s=>s.status==="QUEUED").slice(0,Oe-i.numInProgress),[i.numQueued,i.numInProgress,i.files]),k=i.numInProgress>0||i.numFinished>0;r.useEffect(()=>{w.length!==0&&w.forEach(t=>{const{file:s}=t,p=X(t.file),v=Ne(d,p),T=()=>{y&&y(),d({data:{percentComplete:100,status:"FINISHED"},filesToUpdate:[p],type:"UPDATE_FILES"});const n=`Image ${h} uploaded successfully. It is being processed and will be available shortly.`;I(n,{autoHideDuration:6e3,variant:"success"}),g(O(!1)),B("success",s),N?(j.invalidateQueries(`${he}-list`),_.push("/images")):setTimeout(()=>{ie("/images")},3e3)},x=()=>{d({data:{status:"ERROR"},filesToUpdate:[p],type:"UPDATE_FILES"}),g(O(!1))};if(!E)M().then(n=>{f(n.upload_to),g(O(!0)),d({data:{status:"IN_PROGRESS"},filesToUpdate:[X(t.file)],type:"UPDATE_FILES"}),B("start",s);const{cancel:L,request:Z}=J(n.upload_to,s,v);e.setCancelFn(()=>()=>L()),Z().then(()=>T()).catch(()=>x())}).catch(n=>{d({type:"CLEAR_UPLOAD_HISTORY"}),S(n)});else{B("start",s);const{cancel:n,request:L}=J(E,s,v);e.setCancelFn(n),L().then(()=>T()).catch(()=>{x(),B("fail",s),d({type:"CLEAR_UPLOAD_HISTORY"})})}})},[w]);const{acceptedFiles:A,getInputProps:U,getRootProps:F,isDragAccept:R,isDragActive:$,isDragReject:Q,open:b}=Me({accept:["application/x-gzip","application/gzip"],disabled:u||k,maxFiles:1,maxSize:V,noClick:!0,noKeyboard:!0,onDrop:H,onDropRejected:q}),G=(R||A.length>0)&&!a,P=i.files.length!==0,z=u?"To upload an image, complete the required fields.":"You can browse your device to upload an image file or drop it here.";return o.jsxs(Ze,{...F({}),dropzoneDisabled:u||k,isDragAccept:R,isDragActive:$,isDragReject:Q,children:[o.jsx("input",{...U(),placeholder:z}),o.jsx(We,{children:i.files.map((t,s)=>{const p=t.file.name;return o.jsx(_e,{dispatch:d,displayName:p,error:t.status==="ERROR"?"Error uploading image.":"",fileName:p,overwriteNotice:t.status==="OVERWRITE_NOTICE",percentCompleted:t.percentComplete||0,sizeInBytes:t.file.size||0,type:"image"},s)})}),o.jsxs(Ye,{uploadZoneActive:P,children:[!P&&o.jsx(Ke,{variant:"subtitle2",children:z}),G?null:o.jsx(Xe,{buttonType:"primary","data-testid":"upload-button",disabled:u,onClick:b,children:"Browse Files"})]})]})}),B=(e,a)=>{const l=ne(a.size).formatted;me(e,l)},oo=ye()(e=>({browseFilesButton:{marginLeft:"1rem"},cliModalButton:{...e.applyLinkStyles,fontFamily:e.font.bold},cloudInitCheckboxWrapper:{marginLeft:"3px",marginTop:e.spacing(2)},container:{"& .MuiFormHelperText-root":{marginBottom:e.spacing(2)},minWidth:"100%",paddingBottom:e.spacing(),paddingTop:e.spacing(2)},helperText:{marginTop:e.spacing(2),[e.breakpoints.down("sm")]:{width:"100%"},width:"90%"}})),to=o.jsxs(D,{children:["Only check this box if your Custom Image is compatible with cloud-init, or has cloud-init installed, and the config has been changed to use our data service."," ",o.jsx(re,{to:"https://www.linode.com/docs/products/compute/compute-instances/guides/metadata-cloud-config/",children:"Learn how."})]}),ao=o.jsx(D,{children:"Image files must be raw disk images (.img) compressed using gzip (.gz). The maximum file size is 5 GB (compressed) and maximum image size is 6 GB (uncompressed)."}),yo=e=>{var x;const{changeDescription:a,changeIsCloudInit:l,changeLabel:u,description:c,isCloudInit:h,label:y}=e,{data:C}=fe(),{data:S}=be(),{data:I}=xe(),{mutateAsync:E}=Ce(),{classes:f}=oo(),j=Ie().data??[],M=se(),{push:_}=te(),N=ve(),[i,d]=r.useState(!1),[g,H]=r.useState(""),[q,w]=r.useState(),[k,A]=r.useState(!1),{showGDPRCheckbox:U}=Re({agreements:I,profile:C,regions:j,selectedRegionId:g}),[F,R]=r.useState(null),$=Te(n=>n.pendingUpload),Q=ae(),b=!(C!=null&&C.restricted)||!!((x=S==null?void 0:S.global)!=null&&x.add_images),G=n=>{F&&F(),M(O(!1)),Q?_(n):ie(n)},P=()=>{i&&E({eu_model:!0,privacy_policy:!0}).catch(Ae)},z=!y||!g||!b||U&&!i,t=De(["label","description","region"],q),s=Y(y,"label"),p=Y(c,"description"),v=Y(g,"region"),T=`linode-cli image-upload --label ${s} --description ${p} --region ${v} FILE`;return o.jsxs(o.Fragment,{children:[o.jsx(Fe,{confirmWhenLeaving:!0,onConfirm:G,when:$,children:({handleCancel:n,handleConfirm:L,isModalOpen:Z})=>o.jsx(Se,{actions:()=>o.jsx(we,{primaryButtonProps:{label:"Leave Page",onClick:L},secondaryButtonProps:{label:"Cancel",onClick:n}}),onClose:n,open:Z,title:"Leave this page?",children:o.jsx(D,{variant:"subtitle1",children:"An upload is in progress. If you navigate away from this page, the upload will be canceled."})})}),o.jsxs(Le,{className:f.container,children:[t.none?o.jsx(W,{text:t.none,variant:"error"}):null,b?null:o.jsx(W,{text:"You don't have permissions to create a new Image. Please contact an account administrator for details.",variant:"error"}),o.jsxs("div",{style:{width:"100%"},children:[o.jsx(K,{disabled:!b,errorText:t.label,label:"Label",onChange:u,required:!0,value:y}),o.jsx(K,{disabled:!b,errorText:t.description,label:"Description",multiline:!0,onChange:a,rows:1,value:c}),N.metadata&&o.jsx("div",{className:f.cloudInitCheckboxWrapper,children:o.jsx(Ee,{checked:h,onChange:l,text:"This image is cloud-init compatible",toolTipInteractive:!0,toolTipText:to})}),o.jsx(Pe,{helperText:`For fastest initial upload, select the region that is geographically
            closest to you. Once uploaded you will be able to deploy the image
            to other regions.`,currentCapability:void 0,disabled:!b,errorText:t.region,handleSelection:H,label:"Region",regions:j,required:!0,selectedId:g}),U?o.jsx(je,{centerCheckbox:!0,checked:i,className:f.helperText,onChange:n=>d(n.target.checked)}):null,o.jsx(W,{spacingTop:24,sx:{fontSize:"0.875rem"},variant:"warning",children:ao}),o.jsx(D,{className:f.helperText,children:"Custom Images are billed at $0.10/GB per month based on the uncompressed image size."}),o.jsx(eo,{apiError:t.none,description:c,dropzoneDisabled:z,isCloudInit:h,label:y,onSuccess:P,region:g,setCancelFn:R,setErrors:w}),o.jsxs(D,{sx:{paddingBottom:1,paddingTop:2},children:["Or, upload an image using the"," ",o.jsx("button",{className:f.cliModalButton,onClick:()=>A(!0),children:"Linode CLI"}),". For more information, please see"," ",o.jsx(re,{to:"https://www.linode.com/docs/guides/linode-cli",children:"our guide on using the Linode CLI"}),"."]})]})]}),o.jsx(He,{analyticsKey:"Image Upload",command:T,isOpen:k,onClose:()=>A(!1)})]})},Y=(e,a)=>e?ke(e):`[${a.toUpperCase()}]`;export{yo as ImageUpload,yo as default};
