import{r as j,q as X,f5 as Y,bp as z,gK as U,cx as J,av as Z,j as r,ad as O,bB as ee,B as ae,T as h,ag as re,dV as ne,gL as le,gM as se,a1 as oe,gN as ie,ak as te}from"./index-Eksrs3uK.js";import{u as de}from"./formik.esm-Kap5lsIh.js";import{D as ce}from"./Drawer-A9yKjC3Z.js";import{L as ue}from"./LinodeSelect-y7DOgXsC.js";import{N as be}from"./NodeBalancerSelect-tPR8nvIa.js";import{h as me,a as pe}from"./formikErrorUtils-jhqfCjwU.js";import{g as B}from"./grants-2yY1GgvJ.js";const fe="Additional Linodes",Ee="Additional NodeBalancers",he="Only services you have permission to modify are shown.",ge="Only the firewall's inbound rules apply to NodeBalancers.",ve={devices:{linodes:[],nodebalancers:[]},label:"",rules:{inbound_policy:"ACCEPT",outbound_policy:"ACCEPT"}},Te=j.memo(I=>{var L,T;const d=X(),{createFlow:g,onClose:c,onFirewallCreated:v,open:u}=I,{_hasGrant:D,_isRestrictedUser:b}=Y(),{data:y}=z(),{mutateAsync:R}=U(),{enqueueSnackbar:$}=J(),x=Z(),{errors:l,handleBlur:P,handleChange:k,handleSubmit:q,isSubmitting:M,resetForm:w,setFieldValue:F,status:n,values:m}=de({initialValues:ve,onSubmit(e,{setErrors:s,setStatus:N,setSubmitting:_}){N(void 0),s({});const a={...e};a.label===""&&(a.label=void 0),Array.isArray(a.rules.inbound)&&a.rules.inbound.length===0&&(a.rules.inbound=void 0),Array.isArray(a.rules.outbound)&&a.rules.outbound.length===0&&(a.rules.outbound=void 0),R(a).then(o=>{var t,S;_(!1),$(`Firewall ${a.label} successfully created`,{variant:"success"}),(t=a.devices)!=null&&t.linodes&&a.devices.linodes.forEach(E=>{x.invalidateQueries([ne,"linode",E,"firewalls"])}),(S=a.devices)!=null&&S.nodebalancers&&a.devices.nodebalancers.forEach(E=>{x.invalidateQueries([le,"nodebalancer",E,"firewalls"])}),v&&v(o),c()}).catch(o=>{const t=()=>N({generalError:te([],o).none});_(!1),me(s,o),pe(t,o,"Error creating Firewall.")})},validateOnBlur:!1,validateOnChange:!1,validationSchema:se}),p=d.firewallNodebalancer?"services":"Linodes",G=`Assign ${p} to the Firewall`,K=`Assign one or more ${p} to this firewall. You can add ${p} later if you want to customize your rules first.`;j.useEffect(()=>{u&&w()},[u,w]);const f=b&&!D("add_firewalls"),C=b?B(y,"linode","read_only"):[],A=b?B(y,"nodebalancer","read_only"):[],i=C.length>0||A.length>0?he:void 0,V=e=>!C.includes(e.id),H=e=>!A.includes(e.id),Q=r.jsx(oe,{to:ie,children:"Learn more"}),W=(n==null?void 0:n.generalError)||l["rules.inbound"]||l["rules.outbound"]||l.rules;return r.jsx(ce,{onClose:c,open:u,title:"Create Firewall",children:r.jsxs("form",{onSubmit:q,children:[f?r.jsx(O,{text:"You don't have permissions to create a new Firewall. Please contact an account administrator for details.",variant:"error"}):null,W&&r.jsx(O,{"data-qa-error":!0,text:(n==null?void 0:n.generalError)??"An unexpected error occurred",variant:"error"},n),r.jsx(ee,{inputProps:{autoFocus:!0},"aria-label":"Label for your new Firewall",disabled:f,errorText:l.label,label:"Label",name:"label",onBlur:P,onChange:k,required:!0,value:m.label}),r.jsxs(ae,{children:[r.jsx(h,{sx:e=>({margin:`${e.spacing(2)} ${e.spacing(0)}`}),variant:"h3",children:G}),r.jsxs(h,{children:[K,i?` ${i}`:null]}),d.firewallNodebalancer&&r.jsxs(h,{sx:e=>({margin:`${e.spacing(2)} ${e.spacing(0)}`}),children:[ge,r.jsx("br",{}),Q,"."]})]}),r.jsx(ue,{label:g==="linode"?fe:"Linodes",onSelectionChange:e=>{F("devices.linodes",e.map(s=>s.id))},errorText:l["devices.linodes"],helperText:i,multiple:!0,optionsFilter:V,value:((L=m.devices)==null?void 0:L.linodes)??null}),d.firewallNodebalancer&&r.jsx(be,{label:g==="nodebalancer"?Ee:"NodeBalancers",onSelectionChange:e=>{F("devices.nodebalancers",e.map(s=>s.id))},errorText:l["devices.nodebalancers"],helperText:i,multiple:!0,optionsFilter:H,value:((T=m.devices)==null?void 0:T.nodebalancers)??null}),r.jsx(re,{primaryButtonProps:{"data-testid":"submit",disabled:f,label:"Create Firewall",loading:M,type:"submit"},secondaryButtonProps:{"data-testid":"cancel",label:"Cancel",onClick:c}})]})})});export{Te as C};
