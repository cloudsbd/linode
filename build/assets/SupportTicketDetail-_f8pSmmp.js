import{Z as ae,J as se,j as e,B as q,$ as W,a0 as T,T as f,a1 as S,m as I,r as d,a2 as ne,G as l,a3 as re,a4 as ie,a5 as E,a6 as oe,a7 as ce,a8 as V,a9 as G,aa as le,ab as Q,ac as N,ad as X,ae as de,af as pe,ag as J,ah as ue,ai as M,aj as ge,ak as me,al as xe,am as fe,an as H,s as he,ao as Z,ap as ye,aq as je,X as be,u as ke,e as ve,b as Se,ar as Te,as as Ie,C as B,E as U,U as we,Q as _e}from"./index-Eksrs3uK.js";import{W as Re}from"./index-C8Ov-8_e.js";import{L as Ce}from"./LandingHeader-JXAVBhqg.js";import{D as Le}from"./DateTimeDisplay-bXC9mIcz.js";import{O as K,T as Ae,M as $e,A as De}from"./TabbedReply-8laJdW9a.js";import{S as Fe}from"./ShowMoreExpansion-5I3PKpip.js";import{l as R}from"./over-27tc0FF7.js";import{s as C}from"./set-2Chj4B2I.js";import{S as Pe}from"./StatusIcon-RuV8PvAV.js";import"./remove-KHZAQMPH.js";import"./TabbedPanel-IicwaI6L.js";import"./TabList-4PWL4GSj.js";import"./assocPath-nNkv7F8U.js";const Ee=(t,a,r)=>{try{if(r&&K.includes(r))return!1;const i=ae(a);return i.isValid?t&&i>=se.local().minus({days:7}):!0}catch{return!0}},Ne=t=>{const{linodeUsername:a,replyId:r,ticketId:i}=t,s=`https://secure.teamhively.com/ratings/add/account/587/source/hs/ext/${a}/ticket/${i}-${r}/rating/`;return e.jsxs(q,{sx:{padding:1},children:[e.jsx(W,{}),e.jsxs(T,{alignItems:"center",direction:"row",pl:1,spacing:1.5,children:[e.jsx(f,{sx:{padding:"2px 20px 2px 0"},children:e.jsx(S,{external:!0,to:s+"3",children:"How did I do?"})}),e.jsx(S,{accessibleAriaLabel:"Happy feedback",external:!0,hideIcon:!0,to:s+"3",children:e.jsx("img",{src:"https://secure.teamhively.com/system/smileys/icons/000/000/541/px_25/icon_positive.png",alt:"Happy face emoji"})}),e.jsx(S,{accessibleAriaLabel:"Mediocre feedback",external:!0,hideIcon:!0,to:s+"2",children:e.jsx("img",{src:"https://secure.teamhively.com/system/smileys/icons/000/000/542/px_25/icon_indifferent.png",alt:"Indifferent face emoji"})}),e.jsx(S,{accessibleAriaLabel:"Unhappy feedback",external:!0,hideIcon:!0,to:s+"1",children:e.jsx("img",{src:"https://secure.teamhively.com/system/smileys/icons/000/000/543/px_25/icon_negative.png",alt:"Sad Face emoji"})})]})]})},Me=I()(t=>({expButton:{"& svg":{stroke:t.textColors.tableHeader},left:"auto",position:"absolute",right:4,top:-35},expand:{transform:"rotate(180deg)"},root:{"& pre":{backgroundColor:t.bg.tableHeader},padding:`${t.spacing(2)} ${t.spacing(2)}`,position:"relative"},toggle:{height:22,width:22}})),He=t=>{const{classes:a}=Me(),[r,i]=d.useState(t.open||!0),{text:s}=t,n=ne(s,175),o=r?s:n;return e.jsxs(l,{className:a.root,container:!0,spacing:2,children:[e.jsx(l,{style:{width:"100%"},children:e.jsx(re,{textOrMarkdown:o})}),n!==s&&e.jsx(ie,{"aria-label":"Expand full answer",className:a.expButton,onClick:()=>i(!r),size:"large",children:r?e.jsx(E,{className:a.toggle}):e.jsx(E,{className:`${a.toggle} ${a.expand}`})})]})},Be=I()(t=>({"@keyframes fadeIn":{from:{opacity:0},to:{opacity:1}},content:{backgroundColor:t.color.white,border:`1px solid ${t.color.grey2}`,borderRadius:t.shape.borderRadius,marginRight:t.spacing(2),marginTop:t.spacing(1),width:"100%"},expert:{marginRight:4,whiteSpace:"nowrap"},header:{backgroundColor:t.color.grey2,borderTopLeftRadius:t.shape.borderRadius,borderTopRightRadius:t.shape.borderRadius,minHeight:40,padding:`0 ${t.spacing(1)}`},headerInner:{alignItems:"center",display:"flex",flexWrap:"wrap"},leftIcon:{borderRadius:"50%",color:t.palette.text.primary,height:"100%",width:"100%"},userName:{color:t.color.headline,fontFamily:"LatoWebBold",marginRight:4,whiteSpace:"nowrap"},userWrapper:{alignItems:"center",borderRadius:"50%",display:"flex",height:32,justifyContent:"center",marginTop:t.spacing(.5),position:"relative",[t.breakpoints.down("lg")]:{marginLeft:t.spacing()},[t.breakpoints.up("sm")]:{height:40,marginRight:t.spacing(1),width:40},top:-2,width:32}})),O=d.memo(t=>{const{classes:a}=Be(),{open:r,parentTicket:i,reply:s,ticket:n,ticketUpdated:o}=t,[c,m]=d.useState(void 0);d.useEffect(()=>{if(!(!n&&!s)){if(n)return m({date:n.opened,description:n.description,friendly_name:n.opened_by,from_linode:!1,gravatar_id:n.gravatar_id,reply_id:"",ticket_id:String(n.id),updated:n.updated,username:n.opened_by});if(s)return m({date:s.created,description:s.description,friendly_name:s.friendly_name,from_linode:s.from_linode,gravatar_id:s.gravatar_id,reply_id:String(s.id),ticket_id:i?String(i):"",updated:o,username:s.created_by})}},[i,s,n,o]);const p=y=>e.jsx("div",{className:a.userWrapper,children:e.jsx(oe,{alt:"Gravatar",className:a.leftIcon,src:`https://gravatar.com/avatar/${y}?d=404`,children:e.jsx(ce,{})})});return!c||!c.description?null:e.jsxs(l,{container:!0,wrap:"nowrap",children:[e.jsx(l,{children:p(c.gravatar_id)}),e.jsxs(l,{className:a.content,children:[e.jsx(l,{className:a.header,container:!0,children:e.jsxs(l,{className:a.headerInner,children:[e.jsx(f,{className:a.userName,component:"span",children:c.friendly_name}),c.from_linode&&!K.includes(c.username)?e.jsx(f,{className:a.expert,component:"span",variant:"body1",children:e.jsx("em",{children:"Linode Expert"})}):null,e.jsxs(f,{component:"span",variant:"body1",children:["commented ",e.jsx(Le,{value:c.date})]})]})}),e.jsx(He,{open:r,text:c.description}),Ee(c.from_linode,c.updated,c.username)&&e.jsx(Ne,{linodeUsername:c.username,replyId:c.reply_id,ticketId:c.ticket_id})]})]})});var D={},Ue=G;Object.defineProperty(D,"__esModule",{value:!0});var Y=D.default=void 0,Oe=Ue(V()),ze=e,qe=(0,Oe.default)((0,ze.jsx)("path",{d:"M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"}),"InsertDriveFile");Y=D.default=qe;var F={},We=G;Object.defineProperty(F,"__esModule",{value:!0});var ee=F.default=void 0,Ve=We(V()),Ge=e,Qe=(0,Ve.default)((0,Ge.jsx)("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"}),"InsertPhoto");ee=F.default=Qe;const z=t=>{const{attachments:a,icons:r}=t;return e.jsx(le,{sx:{padding:2},children:e.jsx(T,{divider:e.jsx(W,{}),children:a.map((i,s)=>e.jsxs(T,{alignItems:"center","data-qa-attachment-row":!0,direction:"row",spacing:2,children:[e.jsx(q,{children:r[s]}),e.jsx(f,{component:"span",children:i})]},s))})})},Xe=(t=[])=>{const a=["jpg","jpeg","png","bmp","tiff"];return t.map((r,i)=>{const s=r.lastIndexOf("."),n=r.slice(s+1);return n&&a.includes(n.toLowerCase())?e.jsx(ee,{},i):e.jsx(Y,{},i)})},Je=({attachments:t})=>{const[a,r]=d.useState(!1),i=()=>{r(n=>!n)};if(Q(t))return null;const s=Xe(t);return e.jsx(l,{sx:n=>({marginLeft:n.spacing(6),marginTop:n.spacing(),maxWidth:600,[n.breakpoints.down("sm")]:{marginLeft:n.spacing(5),width:"calc(100% - 32px)"}}),container:!0,justifyContent:"flex-start",children:e.jsxs(l,{sx:{overflowX:"auto"},children:[e.jsx(f,{variant:"h3",children:"Attachments"}),e.jsx(z,{attachments:N(0,5,t),icons:s}),t.length>5&&e.jsx("div",{"data-qa-attachment-toggle":!0,onClick:i,role:"button",style:{display:"inline-block"},tabIndex:0,children:e.jsx(Fe,{name:a?"Show Less Files":"Show More Files",defaultExpanded:!1,children:e.jsx(z,{attachments:N(5,1/0,t),icons:s})})})]})})},Ze=(t,a)=>`Error attaching ${t}: ${a}`,Ke=t=>{const{fileName:a,reason:r}=t;return e.jsx(X,{text:Ze(a,r),variant:"error"})},Ye=I()(t=>({closeLink:{...t.applyLinkStyles}})),et=({ticketId:t})=>{const{classes:a}=Ye(),[r,i]=d.useState(!1),{error:s,isLoading:n,mutateAsync:o}=de(t),c=async()=>{await o(),i(!1)},m=e.jsx(J,{primaryButtonProps:{"data-testid":"dialog-submit",label:"Confirm",loading:n,onClick:c},secondaryButtonProps:{"data-testid":"dialog-cancel",label:"Cancel",onClick:()=>i(!1)}});return e.jsxs(d.Fragment,{children:[e.jsxs(f,{children:["If everything is resolved, you can ",e.jsx("button",{className:a.closeLink,"data-qa-close-ticket-link":!0,onClick:()=>i(!0),title:"Close this ticket",type:"button",children:"close this ticket"}),"."]}),e.jsx(pe,{actions:m,error:s==null?void 0:s[0].reason,onClose:()=>i(!1),open:r,title:"Confirm Ticket Close",children:e.jsx(f,{children:"Are you sure you want to close this ticket?"})})]})},tt=I()(()=>({actions:{display:"flex",justifyContent:"flex-end"}})),at=t=>{const{classes:a}=tt(),{closable:r,isSubmitting:i,submitForm:s,ticketId:n,value:o}=t,c=()=>{s(o)};return e.jsxs(e.Fragment,{children:[r&&e.jsx(et,{ticketId:n}),e.jsx(J,{primaryButtonProps:{label:"Add Update",loading:i,onClick:c},className:a.actions})]})},st=I()(t=>({expPanelSummary:{backgroundColor:t.name==="dark"?t.bg.main:t.bg.white,borderTop:`1px solid ${t.bg.main}`,paddingTop:t.spacing()},reference:{[t.breakpoints.down("sm")]:{padding:`${t.spacing(2)} !important`},[t.breakpoints.up("sm")]:{marginLeft:4,marginRight:4,marginTop:t.spacing(7),padding:"0 !important"}},referenceRoot:{"& > p":{marginBottom:t.spacing()}},replyContainer:{paddingLeft:t.spacing(6),[t.breakpoints.down("sm")]:{paddingLeft:t.spacing(6)}}})),nt=t=>{const{classes:a}=st(),{lastReply:r,onSuccess:i,reloadAttachments:s,...n}=t,{mutateAsync:o}=ue(),c=M.ticketReply.get(),m=c.ticketId===t.ticketId,[p,y]=d.useState(void 0),[g,w]=d.useState(m&&(r==null?void 0:r.description)!==c.text?c.text:""),[L,v]=d.useState(!1),[u,j]=d.useState([]),_=(x,k)=>{M.ticketReply.set({text:x,ticketId:k})},h=d.useRef(ge(500,!1,_)).current;d.useEffect(()=>{g.length>0&&h(g,t.ticketId)},[g,t.ticketId]);const b=()=>{v(!0),y(void 0),o({description:g,ticket_id:t.ticketId}).then(x=>{i&&i(x),v(!1),w("")}).then(()=>{u.forEach((x,k)=>{if(x.uploaded)return;j(C(R([k,"uploading"]),!0));const P=new FormData;P.append("file",x.file??""),fe(t.ticketId,P).then(()=>{const $={file:null,uploaded:!0,uploading:!1};j(C(R([k]),$)),s()}).catch($=>{j(C(R([k,"uploading"]),!1));const te=H($,"There was an error attaching this file. Please try again.");j(C(R([k,"errors"]),te))})})}).catch(x=>{y(H(x,"There was an error creating your reply. Please try again.")),v(!1)})},A=me(["description"],p);return e.jsxs(l,{className:a.replyContainer,children:[A.none&&e.jsx(X,{spacingBottom:8,spacingTop:16,text:A.none,variant:"error"}),e.jsx(l,{children:e.jsx(Ae,{error:A.description,handleChange:w,isReply:!0,value:g})}),e.jsx(l,{style:{marginTop:8},children:e.jsx(xe,{defaultExpanded:!1,detailProps:{className:a.expPanelSummary},heading:"Formatting Tips",children:e.jsx($e,{isReply:!0,rootClass:a.referenceRoot})})}),e.jsxs(l,{children:[e.jsx(De,{updateFiles:x=>j(x),files:u}),e.jsx(at,{isSubmitting:L,submitForm:b,value:g,...n})]})]})},rt=t=>{const{entity:a,status:r,updated:i,updated_by:s}=t,{data:n}=Z(),o=ye(i,{timezone:n==null?void 0:n.timezone}),c=r==="closed"?"Closed":"Last updated",m=()=>{if(!a)return null;const p=be(a);return e.jsxs(f,{children:["| Regarding:"," ",p?e.jsx(S,{to:p,children:a.label}):a.label]})};return e.jsxs(T,{sx:p=>({flexFlow:"row wrap",marginBottom:p.spacing(3),[p.breakpoints.down("md")]:{marginLeft:p.spacing(1)}}),children:[e.jsxs(T,{sx:{display:"inline-flex",flexDirection:"row"},children:[e.jsx(it,{ariaLabel:`Ticket status is ${r}`,status:r==="closed"?"inactive":"active"}),je(r)]})," ",e.jsxs(f,{children:["| ",c," by ",s," at ",o]})," ",m()]})},it=he(Pe,{label:"StyledStatusIcon"})(({theme:t,...a})=>({alignSelf:"center",...a.status==="inactive"&&t.name==="light"&&{backgroundColor:t.color.grey3}})),bt=()=>{var _;const t=ke(),a=ve(),{ticketId:r}=Se(),i=Number(r),s=(_=t.location.state)==null?void 0:_.attachmentErrors,{data:n}=Z(),{data:o,error:c,isLoading:m,refetch:p}=Te(i),{data:y,error:g,fetchNextPage:w,hasNextPage:L,isLoading:v}=Ie(i),u=y==null?void 0:y.pages.flatMap(h=>h.data);if(m)return e.jsx(B,{});if(c)return e.jsx(U,{errorText:c==null?void 0:c[0].reason});if(!o)return null;const j=we({disallowedTagsMode:"discard",sanitizingTier:"none",text:`#${o.id}: ${o.summary}`}).toString();return e.jsxs(d.Fragment,{children:[e.jsx(_e,{segment:`Support Ticket ${r}`}),e.jsx(Ce,{breadcrumbProps:{breadcrumbDataAttrs:{"data-qa-breadcrumb":!0},crumbOverrides:[{linkTo:{pathname:"/support/tickets",search:`type=${o.status==="closed"?"closed":"open"}`},position:2}],pathname:a.pathname},title:j}),e.jsx(rt,{...o}),s!==void 0&&!Q(s)&&(s==null?void 0:s.map((h,b)=>e.jsx(Ke,{fileName:h.file,reason:h.error},b))),e.jsx(l,{container:!0,spacing:2,children:e.jsxs(l,{xs:12,children:[o.description&&e.jsx(O,{isCurrentUser:(n==null?void 0:n.username)===o.opened_by,ticket:o},o.id),u==null?void 0:u.map((h,b)=>e.jsx(O,{isCurrentUser:(n==null?void 0:n.username)===h.created_by,open:b===u.length-1,parentTicket:o?o.id:void 0,reply:h,ticketUpdated:o?o.updated:""},b)),v&&e.jsx(B,{mini:!0}),g?e.jsx(U,{errorText:g==null?void 0:g[0].reason}):null,L&&e.jsx(Re,{onEnter:()=>w()}),e.jsx(Je,{attachments:o.attachments}),["new","open"].includes(o.status)&&e.jsx(nt,{closable:o.closable,lastReply:u&&u[(u==null?void 0:u.length)-1],reloadAttachments:p,ticketId:o.id})]})})]})};export{bt as SupportTicketDetail};
