import{s as k,aW as he,bD as xe,j as e,G as V,T as L,J as I,q as U,ao as Y,ix as Z,iy as be,r as f,ak as X,ad as ee,bB as se,bI as ge,bJ as ye,ag as z,iz as E,iA as je,cx as Ce,af as ke,iB as Ae,iC as fe,B as ve,iD as Se,iE as Te,b1 as we,Q as Pe}from"./index-Eksrs3uK.js";import{A as Re}from"./AddNewLink-LwviGK8c.js";import{D as G}from"./DateTimeDisplay-bXC9mIcz.js";import{P as De}from"./PaginationFooter-NHWf7fW2.js";import{b as ae,a as m,T as v,c as Q}from"./TableRow-phXfWUGW.js";import{T as Oe}from"./TableRowEmpty-aXmC67-Z.js";import{T as Ie}from"./TableRowError-8gKmGX7P.js";import{T as Me}from"./TableRowLoading-iP7zIRHG.js";import{T as N}from"./TableSortCell-hcsagFzN.js";import{S as qe}from"./SecretTokenDialog-Sh51_GwU.js";import{u as Ee}from"./useOrder-rsUMHEuj.js";import{u as Fe}from"./usePagination-Sxr0Tlb7.js";import{A as Le}from"./ActionMenu-4CPisA_2.js";import{I as Be}from"./InlineMenuAction-d5mRENST.js";import{u as ne}from"./formik.esm-Kap5lsIh.js";import{D as $}from"./Drawer-A9yKjC3Z.js";import{F as _e}from"./FormControl-CNHz4Ctl.js";import{R as W}from"./Radio-HudVgwMW.js";import{A as T}from"./AccessCell-Cs7x-Gib.js";import{i as We}from"./isPast-netbmlWS.js";import{T as H}from"./TableHead-Si_pzkLK.js";import"./Skeleton-iwmO4Yae.js";import"./CopyTooltip-mIyzAQ7E.js";import"./index-Y5esPPk-.js";import"./download-J2cziBKr.js";import"./downloadFile-7KribbgA.js";import"./OrderBy-H-bWJCPy.js";import"./splitAt-pbTnq2Oi.js";import"./monitor-ok-uFJibhtB.js";const Ne=k(N,{label:"StyledTableSortCell"})(({theme:s,...r})=>({"&:hover":{"& span":{color:s.textColors.linkActiveLight},cursor:"pointer"},[s.breakpoints.down("lg")]:{width:r.mobileWidth||"25%"},width:r.width||"40%"})),Ve=s=>{const r=he(),a=xe(r.breakpoints.down("md")),{isThirdPartyAccessToken:n,openEditDrawer:o,openRevokeDialog:l,openViewDrawer:i,token:p,type:u}=s,d=[{onClick:()=>{i(p)},title:"View Scopes"},n?null:{onClick:()=>{o(p)},title:"Rename"},{onClick:()=>{l(p,u)},title:"Revoke"}].filter(Boolean);return a?e.jsx(Le,{actionsList:d,ariaLabel:`Action menu for API Token ${s.token.label}`}):e.jsx(e.Fragment,{children:d.map(c=>e.jsx(Be,{actionText:c.title,onClick:c.onClick},c.title))})},ze=k(V,{label:"StyledRootContainer"})(({theme:s})=>({background:s.color.white,margin:0,width:"100%"})),Qe=k(L,{label:"StyledHeadline"})(()=>({marginLeft:7})),$e=k(V,{label:"StyledAddNewWrapper"})(()=>({"&.MuiGrid-item":{padding:5}})),te=k(ae,{label:"StyledPermsTable"})(({theme:s})=>({marginBottom:s.spacing(),marginTop:s.spacing(3)})),He=k(m,{label:"StyledSelectCell"})(()=>({fontFamily:"LatoWebBold",fontSize:".9rem"})),re=k(m,{label:"StyledAccessCell"})(({theme:s})=>({[s.breakpoints.down("md")]:{width:"100%"},width:"31%"})),j=k(m,{label:"StyledPermissionsCell"})(({theme:s})=>({textAlign:"center",[s.breakpoints.down("md")]:{width:"100%"},width:"23%"})),F=["account","child_account","databases","domains","events","firewall","images","ips","linodes","lke","longview","nodebalancers","object_storage","stackscripts","volumes"],C={account:"Account",child_account:"Child Account Access",databases:"Databases",domains:"Domains",events:"Events",firewall:"Firewalls",images:"Images",ips:"IPs",linodes:"Linodes",lke:"Kubernetes",longview:"Longview",nodebalancers:"NodeBalancers",object_storage:"Object Storage",stackscripts:"StackScripts",volumes:"Volumes"},Ge=["none","read_only","read_write"],oe={create:2,delete:2,modify:2,none:0,read_only:1,read_write:2,view:1},Je=s=>s.reduce((r,a)=>({...r,[a]:0}),{}),Ke=new RegExp(/[, ]/),le=s=>{if(s==="*")return F.map(o=>[o,2]);const r=s.split(Ke).reduce((o,l)=>{const[i,p]=l.split(":");return{...o,[i]:oe[p]}},Je(F)),n=Object.entries({account:["tokens","clients","users","tickets","managed"]}).reduce((o,[l,i])=>{const p=i.reduce((u,d)=>{const c=o[d];return c?Math.max(u,c):u},o[l]);return{...o,[l]:p}},r);return F.reduce((o,l)=>{const i=[l,n[l]];return[...o,i]},[])},Ue=(s,r)=>s.length!==r.length?!1:s.reduce((a,[n,o])=>o===oe.read_write&&a,!0),Ye=s=>Ue(s,F)?"*":s.reduce((a,[n,o])=>{const l=Ge[o];return l!=="none"?[...a,[n,l].join(":")]:[...a]},[]).join(" "),Ze=s=>{const r=s[0],a=n=>n[1]===r[1];return s.slice(1).every(a)?r[1]:null},Xe=s=>{const r=I.local().plus({years:100}).toISO();return We(r)(s)},es=()=>[["In 6 months",I.local().plus({months:6}).startOf("day").toFormat(E)],["In 3 months",I.local().plus({months:3}).startOf("day").toFormat(E)],["In 1 month",I.local().plus({months:1}).startOf("day").toFormat(E)],["Never",I.local().plus({years:200}).startOf("day").toFormat(E)]],ss=s=>{const r=es(),{onClose:a,open:n,showSecret:o}=s,l=U(),i={expiry:r[0][1],label:"",scopes:le("")},{data:p}=Y(),{data:u}=Z((p==null?void 0:p.username)??""),{error:d,isLoading:c,mutateAsync:B}=be(),h=ne({initialValues:i,async onSubmit(t){const{token:b}=await B({expiry:t.expiry,label:t.label,scopes:Ye(t.scopes)});a(),o(b??"Secret not available")}});f.useEffect(()=>{n&&h.resetForm({values:i})},[n]);const S=t=>{const b=h.values.scopes,A=b.findIndex(O=>O[0]===t.currentTarget.name);A!==void 0&&(b[A][1]=+t.currentTarget.value),h.setFieldValue("scopes",b)},w=t=>{const b=+t.currentTarget.value,A=h.values.scopes.map(O=>[O[0],b]);h.setFieldValue("scopes",A)},M=t=>{h.setFieldValue("expiry",t.value)},P=Ze(h.values.scopes),y=X(["label","scopes"],d),q=r.map(t=>({label:t[0],value:t[1]})),R=h.values.scopes,_=l.parentChildAccountAccess&&(u==null?void 0:u.user_type)!=="parent"||!l.parentChildAccountAccess,D=R.filter(t=>C[t[0]]!=="Child Account Access");return e.jsxs($,{onClose:a,open:n,title:"Add Personal Access Token",children:[y.none&&e.jsx(ee,{text:y.none,variant:"error"}),e.jsx(se,{errorText:y.label,label:"Label",name:"label",onChange:h.handleChange,value:h.values.label}),e.jsx(_e,{"data-testid":"expiry-select",children:e.jsx(ge,{isClearable:!1,label:"Expiry",name:"expiry",onChange:M,options:q,value:q.find(t=>t.value===h.values.expiry)})}),e.jsxs(te,{"aria-label":"Personal Access Token Permissions",spacingBottom:16,spacingTop:24,children:[e.jsx(H,{children:e.jsxs(v,{children:[e.jsx(m,{"data-qa-perm-access":!0,children:"Access"}),e.jsx(m,{"data-qa-perm-none":!0,style:{textAlign:"center"},children:"None"}),e.jsx(m,{"data-qa-perm-read":!0,noWrap:!0,style:{textAlign:"center"},children:"Read Only"}),e.jsx(m,{"data-qa-perm-rw":!0,style:{textAlign:"left"},children:"Read/Write"})]})}),e.jsxs(Q,{children:[e.jsxs(v,{"data-qa-row":"Select All",children:[e.jsx(He,{padding:"checkbox",parentColumn:"Access",children:"Select All"}),e.jsx(j,{padding:"checkbox",parentColumn:"None",children:e.jsx(W,{inputProps:{"aria-label":"Select none for all"},checked:P===0,"data-qa-perm-none-radio":!0,"data-testid":"set-all-none",name:"Select All",onChange:w,value:"0"})}),e.jsx(j,{padding:"checkbox",parentColumn:"Read Only",children:e.jsx(W,{inputProps:{"aria-label":"Select read-only for all"},checked:P===1,"data-qa-perm-read-radio":!0,"data-testid":"set-all-read",name:"Select All",onChange:w,value:"1"})}),e.jsx(j,{padding:"checkbox",parentColumn:"Read/Write",children:e.jsx(W,{inputProps:{"aria-label":"Select read/write for all"},checked:P===2,"data-qa-perm-rw-radio":!0,"data-testid":"set-all-write",name:"Select All",onChange:w,value:"2"})})]}),(_?D:R).map(t=>C[t[0]]?e.jsxs(v,{"data-qa-row":C[t[0]],children:[e.jsx(re,{padding:"checkbox",parentColumn:"Access",children:C[t[0]]}),e.jsx(j,{padding:"checkbox",parentColumn:"None",children:e.jsx(T,{active:t[1]===0,disabled:!1,onChange:S,scope:"0",scopeDisplay:t[0],viewOnly:!1})}),e.jsx(j,{padding:"checkbox",parentColumn:"Read Only",children:e.jsx(T,{active:t[1]===1,disabled:!1,onChange:S,scope:"1",scopeDisplay:t[0],viewOnly:!1})}),e.jsx(j,{padding:"checkbox",parentColumn:"Read/Write",children:e.jsx(T,{active:t[1]===2,disabled:!1,onChange:S,scope:"2",scopeDisplay:t[0],viewOnly:!1})})]},t[0]):null)]})]}),y.scopes&&e.jsx(ye,{error:!0,children:y.scopes}),e.jsx(z,{primaryButtonProps:{"data-testid":"create-button",label:"Create Token",loading:c,onClick:()=>h.handleSubmit()},secondaryButtonProps:{label:"Cancel",onClick:a}})]})},as=s=>{const{onClose:r,open:a,token:n}=s,{error:o,isLoading:l,mutateAsync:i}=je((n==null?void 0:n.id)??-1),p=ne({enableReinitialize:!0,initialValues:{label:n==null?void 0:n.label},async onSubmit(d){await i(d),r()}}),u=X(["label"],o);return e.jsxs($,{onClose:r,open:a,title:"Edit Personal Access Token",children:[u.none&&e.jsx(ee,{text:u.none,variant:"error"}),e.jsx(se,{errorText:u.label,label:"Label",name:"label",onChange:p.handleChange,value:p.values.label}),e.jsx(z,{primaryButtonProps:{"data-testid":"save-button",disabled:!p.dirty,label:"Save",loading:l,onClick:()=>p.handleSubmit()},secondaryButtonProps:{label:"Cancel",onClick:r}})]})},ns=({onClose:s,open:r,token:a,type:n})=>{const l={"OAuth Client Token":Ae,"Personal Access Token":fe}[n],{error:i,isLoading:p,mutateAsync:u}=l((a==null?void 0:a.id)??-1),{enqueueSnackbar:d}=Ce(),c=()=>{u().then(()=>{s(),d(`Successfully revoked ${a==null?void 0:a.label}`,{variant:"success"})})};return e.jsx(ke,{actions:e.jsx(z,{primaryButtonProps:{"data-testid":"revoke-button",label:"Revoke",loading:p,onClick:c},secondaryButtonProps:{"data-testid":"cancel-button",label:"Cancel",onClick:s}}),error:i==null?void 0:i[0].reason,onClose:s,open:r,title:`Revoke ${a==null?void 0:a.label}?`,children:e.jsx(L,{children:"Are you sure you want to revoke this API Token?"})})},ts=s=>{const{onClose:r,open:a,token:n}=s,o=U(),{data:l}=Y(),{data:i}=Z((l==null?void 0:l.username)??""),p=le((n==null?void 0:n.scopes)??""),u=o.parentChildAccountAccess&&(i==null?void 0:i.user_type)!=="parent"||!o.parentChildAccountAccess,d=p.filter(c=>C[c[0]]!=="Child Account Access");return e.jsx($,{onClose:r,open:a,title:(n==null?void 0:n.label)??"Token",children:e.jsxs(te,{"aria-label":"Personal Access Token Permissions",spacingBottom:16,spacingTop:24,children:[e.jsx(H,{children:e.jsxs(v,{children:[e.jsx(m,{"data-qa-perm-access":!0,children:"Access"}),e.jsx(m,{"data-qa-perm-none":!0,style:{textAlign:"center"},children:"None"}),e.jsx(m,{"data-qa-perm-read":!0,noWrap:!0,style:{textAlign:"center"},children:"Read Only"}),e.jsx(m,{"data-qa-perm-rw":!0,style:{textAlign:"left"},children:"Read/Write"})]})}),e.jsx(Q,{children:(u?d:p).map(c=>C[c[0]]?e.jsxs(v,{"data-qa-row":C[c[0]],children:[e.jsx(re,{padding:"checkbox",parentColumn:"Access",children:C[c[0]]}),e.jsx(j,{padding:"checkbox",parentColumn:"None",children:e.jsx(T,{active:c[1]===0,disabled:!1,onChange:()=>null,scope:"0",scopeDisplay:c[0],viewOnly:!0})}),e.jsx(j,{padding:"checkbox",parentColumn:"Read Only",children:e.jsx(T,{active:c[1]===1,disabled:!1,onChange:()=>null,scope:"1",scopeDisplay:c[0],viewOnly:!0})}),e.jsx(m,{padding:"checkbox",parentColumn:"Read/Write",children:e.jsx(T,{active:c[1]===2,disabled:!1,onChange:()=>null,scope:"2",scopeDisplay:c[0],viewOnly:!0})})]},c[0]):null)})]})})},J="api-tokens",K=s=>{const{title:r,type:a}=s,{handleOrderChange:n,order:o,orderBy:l}=Ee({order:"desc",orderBy:"created"},`${J}-order}`,a==="OAuth Client Token"?"oauth":"token"),i=Fe(1,J),u={"OAuth Client Token":Se,"Personal Access Token":Te}[a],{data:d,error:c,isLoading:B}=u({page:i.page,page_size:i.pageSize},{"+order":o,"+order_by":l}),[h,S]=f.useState(!1),[w,M]=f.useState(!1),[P,y]=f.useState(!1),[q,R]=f.useState(!1),[_,D]=f.useState(),t=d==null?void 0:d.data.find(x=>x.id===_),[b,A]=f.useState({open:!1,token:void 0}),O=()=>{A({open:!1,token:""})},ie=x=>{A({open:!0,token:x})},ce=x=>{y(!0),D(x.id)},de=x=>{R(!0),D(x.id)},pe=x=>{M(!0),D(x.id)},ue=()=>B?e.jsx(Me,{columns:4}):c?e.jsx(Ie,{colSpan:4,message:c[0].reason}):(d==null?void 0:d.results)===0?e.jsx(Oe,{colSpan:6}):me((d==null?void 0:d.data)??[]),me=x=>x.map(g=>e.jsxs(v,{ariaLabel:g.label,"data-qa-table-row":g.label,children:[e.jsx(m,{"data-qa-token-label":!0,children:g.label}),e.jsx(m,{children:e.jsx(L,{"data-qa-token-created":!0,variant:"body1",children:e.jsx(G,{value:g.created})})}),e.jsx(m,{children:e.jsx(L,{"data-qa-token-expiry":!0,variant:"body1",children:g.expiry===null||Xe(g.expiry)?"never":e.jsx(G,{value:g.expiry})})}),e.jsx(m,{actionCell:!0,children:e.jsx(Ve,{isThirdPartyAccessToken:r==="Third Party Access Tokens",openEditDrawer:de,openRevokeDialog:pe,openViewDrawer:ce,token:g,type:a})})]},g.id));return e.jsxs(ve,{children:[e.jsxs(ze,{alignItems:"center",container:!0,justifyContent:"space-between",spacing:2,children:[e.jsx(V,{children:e.jsx(Qe,{"data-qa-table":a,variant:"h3",children:r})}),e.jsx($e,{children:a==="Personal Access Token"&&e.jsx(Re,{label:"Create a Personal Access Token",onClick:()=>S(!0)})})]}),e.jsxs(ae,{"aria-label":`List of ${r}`,children:[e.jsx(H,{children:e.jsxs(v,{"data-qa-table-head":!0,children:[e.jsx(Ne,{active:l==="label",direction:o,handleClick:n,label:"label",children:"Label"}),e.jsx(N,{active:l==="created",direction:o,handleClick:n,label:"created",children:"Created"}),e.jsx(N,{active:l==="expiry",direction:o,handleClick:n,label:"expiry",children:"Expires"}),e.jsx(m,{})]})}),e.jsx(Q,{children:ue()})]}),e.jsx(De,{count:(d==null?void 0:d.results)??0,eventCategory:"api tokens table",handlePageChange:i.handlePageChange,handleSizeChange:i.handlePageSizeChange,page:i.page,pageSize:i.pageSize}),e.jsx(ss,{onClose:()=>S(!1),open:h,showSecret:ie}),e.jsx(ts,{onClose:()=>y(!1),open:P,token:t}),e.jsx(as,{onClose:()=>R(!1),open:q,token:t}),e.jsx(ns,{onClose:()=>M(!1),open:w,token:t,type:a}),e.jsx(qe,{onClose:O,open:b.open,title:"Personal Access Token",value:b.token})]})},qs=()=>e.jsxs(we,{spacing:2,children:[e.jsx(Pe,{segment:"API Tokens"}),e.jsx(K,{title:"Personal Access Tokens",type:"Personal Access Token"}),e.jsx(K,{title:"Third Party Access Tokens",type:"OAuth Client Token"})]});export{qs as APITokens};
