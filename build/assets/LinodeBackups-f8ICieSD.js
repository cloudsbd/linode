import{j as e,mj as J,Z as I,J as E,r as f,gB as Y,s as C,eN as G,T as y,cx as B,af as _,ag as T,mE as X,dE as M,B as K,ak as z,aa as F,ad as S,bB as ee,f as H,c as q,N as ae,bI as R,d0 as se,cQ as te,bJ as N,ao as W,dh as ne,aX as $,b as oe,u as ie,bp as re,dr as le,E as de,C as ce,b1 as ue,iU as pe}from"./index-Eksrs3uK.js";import{T as V,a as p,b as he,c as me}from"./TableRow-phXfWUGW.js";import{T as be}from"./TableRowEmpty-aXmC67-Z.js";import{E as ye,u as ge,a as xe,b as ke,c as fe}from"./EnableBackupsDialog-5TgOa3Ei.js";import{a as je}from"./backups-brLSog0e.js";import{L as Q}from"./LinodePermissionsError-htxzmi5m.js";import{D as ve}from"./DateTimeDisplay-bXC9mIcz.js";import{S as Ce}from"./StatusIcon-RuV8PvAV.js";import{A as Se}from"./ActionMenu-4CPisA_2.js";import{C as we}from"./Currency-No8tnN7b.js";import{u as A}from"./formik.esm-Kap5lsIh.js";import{F as L}from"./FormControl-CNHz4Ctl.js";import{D as Be}from"./Drawer-A9yKjC3Z.js";import{s as Te}from"./sortBy-avzW26A0.js";import{T as Le}from"./TableHead-Si_pzkLK.js";import"./constants-KokzTiEs.js";const De=t=>{if(t.as("hours")>=1){const a=t.shiftTo("hours","minutes"),r=Math.round(a.minutes);return`${a.hours} hour${a.hours>1?"s":""}, ${r} minute${r>=2?"s":""}`}if(t.as("minutes")>=1){const a=t.shiftTo("minutes","seconds"),r=Math.round(a.seconds);return`${a.minutes} minute${a.minutes>1?"s":""}, ${r} second${r>=2?"s":""}`}const i=t.as("seconds"),n=Math.round(i);return`${n} second${n>=2?"s":""}`},Pe=t=>{const{disabled:s,onDeploy:l,onRestore:i}=t,n={disabled:s,tooltip:s?"You don't have permission to deploy from this Linodeâ€™s backups":void 0},a=[{onClick:()=>{i()},title:"Restore to Existing Linode",...n},{onClick:()=>{l()},title:"Deploy New Linode",...n}];return e.jsx(Se,{actionsList:a,ariaLabel:`Action menu for Backup ${t.backup.label}`})},O={auto:"Automatic",snapshot:"Manual"},Re={failed:"Failed",needsPostProcessing:"Processing",paused:"Paused",pending:"Pending",running:"Running",successful:"Success",userAborted:"Aborted"},Me={failed:"error",needsPostProcessing:"other",paused:"inactive",pending:"other",running:"other",successful:"active",userAborted:"error"},P=t=>{const{backup:s,disabled:l,handleDeploy:i,handleRestore:n}=t;return e.jsxs(V,{"data-qa-backup":!0,children:[e.jsx(p,{"data-qa-backup-name":s.label||O[s.type],parentColumn:"Label",children:s.label||O[s.type]}),e.jsxs(p,{"data-qa-backup-name":s.status,parentColumn:"Status",statusCell:!0,children:[e.jsx(Ce,{status:Me[s.status]??"other"}),Re[s.status]]}),e.jsx(p,{parentColumn:"Date Created",children:e.jsx(ve,{value:s.created})}),e.jsx(p,{parentColumn:"Duration",children:De(J.fromMillis((s.finished?I(s.finished).toMillis():E.now().toMillis())-I(s.created).toMillis()))}),e.jsx(p,{"data-qa-backup-disks":!0,parentColumn:"Disks",children:s.disks.map((a,r)=>e.jsxs("div",{children:[a.label," (",a.filesystem,") - ",a.size," MB"]},r))}),e.jsxs(p,{"data-qa-space-required":!0,parentColumn:"Space Required",children:[s.disks.reduce((a,r)=>a+r.size,0)," MB"]}),e.jsx(p,{actionCell:!0,children:e.jsx(Pe,{backup:s,disabled:l,onDeploy:i,onRestore:n})})]},s.id)},Fe=f.memo(t=>{const{backupsMonthlyPrice:s,disabled:l,linodeId:i}=t,[n,a]=f.useState(!1),r=s?e.jsxs(y,{variant:"subtitle1",children:["Three backup slots are executed and rotated automatically: a daily backup, a 2-7 day old backup, and an 8-14 day old backup. To enable backups for just"," ",e.jsxs("strong",{children:[e.jsx(we,{quantity:s})," per month"]}),", click below."]}):e.jsx(y,{variant:"subtitle1",children:"Three backup slots are executed and rotated automatically: a daily backup, a 2-7 day old backup, and 8-14 day old backup. To enable backups just click below."});return e.jsxs(e.Fragment,{children:[l&&e.jsx(Q,{}),e.jsx(qe,{buttonProps:[{children:"Enable Backups",disabled:l,onClick:()=>a(!0)}],icon:Y,isEntity:!0,renderAsSecondary:!0,title:"Backups",children:r}),e.jsx(ye,{linodeId:i,onClose:()=>a(!1),open:n})]})}),qe=C(G,{label:"StyledPlaceholder"})({"& svg":{transform:"scale(0.75)"}}),Ae=t=>{const{isOpen:s,linodeId:l,onClose:i}=t,{enqueueSnackbar:n}=B(),{error:a,isLoading:r,mutateAsync:o}=ge(l),h=async()=>{await o(),n("Backups are being canceled for this Linode",{variant:"info"}),i(),M(),X()};return e.jsxs(_,{actions:e.jsx(T,{primaryButtonProps:{"data-testid":"confirm-cancel",label:"Cancel Backups",loading:r,onClick:h},secondaryButtonProps:{"data-testid":"cancel-cancel",label:"Close",onClick:i},style:{padding:0}}),error:a==null?void 0:a[0].reason,onClose:i,open:s,title:"Confirm Cancellation",children:[e.jsx(y,{children:"Canceling backups associated with this Linode will delete all existing backups. Are you sure?"}),e.jsxs(y,{style:{marginTop:12},children:[e.jsx("strong",{children:"Note: "}),"Once backups for this Linode have been canceled, you cannot re-enable them for 24 hours."]})]})},Ie=t=>{const{error:s,loading:l,onClose:i,onSnapshot:n,open:a}=t,r=e.jsx(T,{primaryButtonProps:{"data-testid":"confirm",label:"Take Snapshot",loading:l,onClick:n},secondaryButtonProps:{"data-testid":"cancel",label:"Cancel",onClick:i},style:{padding:0}});return e.jsx(_,{actions:r,error:s,onClose:i,open:a,title:"Take a snapshot?",children:e.jsx(y,{children:"Taking a snapshot will back up your Linode in its current state, overriding your previous snapshot. Are you sure?"})})},$e=t=>{const{isReadOnly:s,linodeId:l}=t,{enqueueSnackbar:i}=B(),{error:n,isLoading:a,mutateAsync:r}=xe(l),[o,h]=f.useState(!1),u=A({initialValues:{label:""},async onSubmit(j,g){await r(j),i("Starting to capture snapshot",{variant:"info"}),h(!1),g.resetForm(),M()}}),c=z(["label"],n);return e.jsxs(F,{children:[e.jsx(y,{"data-qa-manual-heading":!0,variant:"h2",children:"Manual Snapshot"}),e.jsx(y,{"data-qa-manual-desc":!0,marginTop:1,variant:"body1",children:"You can make a manual backup of your Linode by taking a snapshot. Creating the manual snapshot can take several minutes, depending on the size of your Linode and the amount of data you have stored on it. The manual snapshot will not be overwritten by automatic backups."}),e.jsxs(L,{children:[c.none&&e.jsx(S,{spacingBottom:8,variant:"error",children:c.none}),e.jsxs(Oe,{children:[e.jsx(ee,{sx:{minWidth:275},"data-qa-manual-name":!0,errorText:c.label,label:"Name Snapshot",name:"label",onChange:u.handleChange,value:u.values.label}),e.jsx(H,{buttonType:"primary","data-qa-snapshot-button":!0,disabled:u.values.label===""||s,onClick:()=>h(!0),children:"Take Snapshot"})]})]}),e.jsx(Ie,{loading:a,onClose:()=>h(!1),onSnapshot:()=>u.handleSubmit(),open:o})]})},Oe=C(K,{label:"StyledBox"})(({theme:t})=>({"& > div":{marginRight:t.spacing(2),width:"auto"},"& button":{marginTop:t.spacing(4)},alignItems:"flex-end",display:"flex",flexDirection:"row",flexWrap:"wrap"})),Ee=t=>{const{backup:s,linodeId:l,onClose:i,open:n}=t,{enqueueSnackbar:a}=B(),{data:r}=q(l,n),{data:o,error:h,isLoading:u}=ae({},{region:r==null?void 0:r.region},n&&r!==void 0),{error:c,isLoading:j,mutateAsync:g,reset:v}=ke(),d=A({enableReinitialize:!0,initialValues:{linode_id:l,overwrite:!1},async onSubmit(m){await g({backupId:(s==null?void 0:s.id)??-1,linodeId:l,overwrite:m.overwrite,targetLinodeId:m.linode_id??-1}),a(`Started restoring Linode ${k==null?void 0:k.label} from a backup`,{variant:"info"}),M(),i()}});f.useEffect(()=>{n&&(d.resetForm(),v())},[n]);const w=(o==null?void 0:o.map(({id:m,label:D})=>({label:D,value:m})))??[],k=w.find(m=>m.value===d.values.linode_id),x=z(["linode_id","overwrite"],c);return e.jsx(Be,{onClose:i,open:n,title:`Restore Backup from ${s==null?void 0:s.created}`,children:e.jsxs("form",{onSubmit:d.handleSubmit,children:[!!x.none&&e.jsx(S,{variant:"error",children:x.none}),e.jsx(R,{textFieldProps:{dataAttrs:{"data-qa-select-linode":!0}},errorText:(h==null?void 0:h[0].reason)??x.linode_id,isClearable:!1,isLoading:u,label:"Linode",onChange:m=>d.setFieldValue("linode_id",m.value),options:w,placeholder:"Select a Linode",value:k}),e.jsxs(L,{sx:{paddingLeft:.4},children:[e.jsx(se,{control:e.jsx(te,{checked:d.values.overwrite,name:"overwrite",onChange:d.handleChange}),label:"Overwrite Linode"}),e.jsx(N,{sx:{marginLeft:0},children:"Overwriting will delete all disks and configs on the target Linode before restoring"})]}),!!x.overwrite&&e.jsx(S,{variant:"error",children:x.overwrite}),d.values.overwrite&&e.jsx(S,{text:`This will delete all disks and configs on ${k?`Linode ${k.label}`:"the selcted Linode"}`,spacingBottom:0,spacingTop:12,variant:"warning"}),e.jsx(T,{primaryButtonProps:{"data-testid":"restore-submit",label:"Restore",loading:j,type:"submit"},secondaryButtonProps:{"data-testid":"restore-cancel",label:"Cancel",onClick:i}})]})})},_e=t=>t===0||t%2===0?t:t-1,ze=(t,s)=>{let l=[0,2,4,6,8,10,12,14,16,18,20,22].map(i=>{const n=E.fromObject({hour:i},{zone:"utc"}).setZone(t),a=n.plus({hours:2});return[`${n.toFormat("HH:mm")} - ${a.toFormat("HH:mm")}`,`W${_e(n.setZone("utc").hour)}`]});return l=Te(i=>i[0],l),s&&l.unshift(["Choose a time","Scheduling"]),l},He=t=>{const{isReadOnly:s,linodeId:l}=t,{enqueueSnackbar:i}=B(),{data:n}=W(),{data:a}=q(l),{error:r,isLoading:o,mutateAsync:h}=ne(l),u=A({enableReinitialize:!0,initialValues:{day:a==null?void 0:a.backups.schedule.day,window:a==null?void 0:a.backups.schedule.window},async onSubmit(d){await h({backups:{schedule:d}}),i("Backup settings saved",{variant:"success"})}}),c=[["Choose a day","Scheduling"],["Sunday","Sunday"],["Monday","Monday"],["Tuesday","Tuesday"],["Wednesday","Wednesday"],["Thursday","Thursday"],["Friday","Friday"],["Saturday","Saturday"]],g=ze($(n==null?void 0:n.timezone),!0).map(d=>({label:d[0],value:d[1]})),v=c.map(d=>({label:d[0],value:d[1]}));return e.jsx(F,{children:e.jsxs("form",{onSubmit:u.handleSubmit,children:[e.jsx(y,{"data-qa-settings-heading":!0,variant:"h2",children:"Settings"}),e.jsx(y,{"data-qa-settings-desc":!0,marginTop:1,variant:"body1",children:"Configure when automatic backups are initiated. The Linode Backup Service will generate a backup between the selected hours every day, and will overwrite the previous daily backup. The selected day is when the backup is promoted to the weekly slot. Up to two weekly backups are saved."}),!!r&&e.jsx(S,{spacingBottom:0,spacingTop:16,variant:"error",children:r==null?void 0:r[0].reason}),e.jsx(Ne,{children:e.jsx(R,{textFieldProps:{dataAttrs:{"data-qa-weekday-select":!0}},value:v.find(d=>d.value===u.values.day),disabled:s,isClearable:!1,label:"Day of Week",name:"Day of Week",noMarginTop:!0,onChange:d=>u.setFieldValue("day",d.value),options:v,placeholder:"Choose a day"})}),e.jsxs(L,{children:[e.jsx(R,{onChange:d=>u.setFieldValue("window",d.value),textFieldProps:{dataAttrs:{"data-qa-time-select":!0}},value:g.find(d=>d.value===u.values.window),disabled:s,isClearable:!1,label:"Time of Day",name:"Time of Day",noMarginTop:!0,options:g,placeholder:"Choose a time"}),e.jsxs(N,{sx:{marginLeft:0},children:["Time displayed in"," ",$(n==null?void 0:n.timezone).replace("_"," ")]})]}),e.jsx(We,{primaryButtonProps:{"data-testid":"schedule",disabled:s||!u.dirty,label:"Save Schedule",loading:o,type:"submit"}})]})})},Ne=C(L,{label:"StyledFormControl"})(({theme:t})=>({"& .react-select__menu-list":{maxHeight:"none"},marginRight:t.spacing(2),minWidth:150})),We=C(T,{label:"StyledActionsPanel"})(({theme:t})=>({"& button":{marginLeft:0,marginTop:t.spacing(2)},justifyContent:"flex-start",margin:0,padding:0})),da=()=>{const{linodeId:t}=oe(),s=Number(t),l=ie(),{data:i}=W(),{data:n}=re(),{data:a}=q(s),{data:r}=le((a==null?void 0:a.type)??"",!!(a!=null&&a.type)),{data:o,error:h,isLoading:u}=fe(s,!!(a!=null&&a.backups.enabled)),c=!!(i!=null&&i.restricted)&&(n==null?void 0:n.linode.find(b=>b.id===(a==null?void 0:a.id)&&b.permissions!=="read_write"))!==void 0,[j,g]=f.useState(!1),[v,d]=f.useState(!1),[w,k]=f.useState(),x=b=>{l.push(`/linodes/create?type=Backups&backupID=${b.id}&linodeID=${a==null?void 0:a.id}&typeID=${a==null?void 0:a.type}`)},m=b=>{g(!0),k(b)};if(h)return e.jsx(de,{errorText:"There was an issue retrieving your backups."});const D=je({region:a==null?void 0:a.region,type:r});if(u)return e.jsx(ce,{});if(!(a!=null&&a.backups.enabled))return e.jsx(Fe,{backupsMonthlyPrice:D,disabled:c,linodeId:s});const U=o!==void 0&&((o==null?void 0:o.automatic.length)>0||!!(o!=null&&o.snapshot.current)||!!(o!=null&&o.snapshot.in_progress));return e.jsxs(ue,{spacing:2,children:[c&&e.jsx(Q,{}),e.jsx(F,{style:{padding:0},children:e.jsxs(he,{"aria-label":"List of Backups",children:[e.jsx(Le,{children:e.jsxs(V,{children:[e.jsx(p,{children:"Label"}),e.jsx(p,{children:"Status"}),e.jsx(p,{children:"Date Created"}),e.jsx(p,{children:"Duration"}),e.jsx(p,{children:"Disks"}),e.jsx(p,{children:"Space Required"}),e.jsx(p,{})]})}),e.jsx(me,{children:U?e.jsxs(e.Fragment,{children:[o==null?void 0:o.automatic.map((b,Z)=>e.jsx(P,{backup:b,disabled:c,handleDeploy:()=>x(b),handleRestore:()=>m(b)},Z)),!!(o!=null&&o.snapshot.current)&&e.jsx(P,{handleDeploy:()=>x(o.snapshot.current),handleRestore:()=>m(o.snapshot.current),backup:o.snapshot.current,disabled:c}),!!(o!=null&&o.snapshot.in_progress)&&e.jsx(P,{handleDeploy:()=>x(o.snapshot.in_progress),handleRestore:()=>m(o.snapshot.in_progress),backup:o.snapshot.in_progress,disabled:c})]}):e.jsx(be,{colSpan:7,message:"Automatic and manual backups will be listed here"})})]})}),e.jsx($e,{isReadOnly:c,linodeId:s}),e.jsx(He,{isReadOnly:c,linodeId:s}),e.jsxs(pe,{children:[e.jsx(Ve,{buttonType:"outlined","data-qa-cancel":!0,disabled:c,onClick:()=>d(!0),children:"Cancel Backups"}),e.jsx(Qe,{"data-qa-cancel-desc":!0,variant:"body1",children:"Please note that when you cancel backups associated with this Linode, this will remove all existing backups."})]}),e.jsx(Ee,{backup:w,linodeId:s,onClose:()=>g(!1),open:j}),e.jsx(Ae,{isOpen:v,linodeId:s,onClose:()=>d(!1)})]})},Ve=C(H,{label:"StyledCancelButton"})(({theme:t})=>({marginBottom:t.spacing(1),[t.breakpoints.down("md")]:{marginLeft:t.spacing(),marginRight:t.spacing()}})),Qe=C(y,{label:"StyledCancelTypography"})(({theme:t})=>({[t.breakpoints.down("md")]:{marginLeft:t.spacing(),marginRight:t.spacing()}}));export{da as LinodeBackups,da as default};
