var we=Object.defineProperty;var Le=(n,h,t)=>h in n?we(n,h,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[h]=t;var u=(n,h,t)=>(Le(n,typeof h!="symbol"?h+"":h,t),t);import{r as x,j as e,C as ee,s as N,T as k,f as H,g as Be,Q as te,B as W,af as De,cA as A,i$ as Pe,d7 as j,j0 as Ee,gL as V,j1 as Ae,an as O,al as $,ag as Ie,j2 as Me,j3 as $e,eX as Re,cb as Fe,j4 as Ue,w as qe,j5 as _e,j6 as Ge,ao as je,bp as He,j7 as Oe,V as J,aq as We,j8 as se,b1 as Ke,a1 as oe,j9 as Qe,q as ae,aW as xe,b as F,ja as U,jb as K,bB as re,bN as Ve,bJ as Xe,aa as Ne,jc as ze,ba as Ye,ex as Je,m as Ze,aX as et,jd as tt,E as R,je as st,G as ne,u as at,e as nt,ak as ot,ad as rt,bq as it}from"./index-Eksrs3uK.js";import{L as lt}from"./LandingHeader-JXAVBhqg.js";import{S as X}from"./SafeTabPanel-S0Pp8CVT.js";import{T as ct}from"./TabLinkList-BrXtJznm.js";import{a as dt,T as ht}from"./TabList-4PWL4GSj.js";import{a as I}from"./append-Xa6QMsiD.js";import{l as D,o as z}from"./over-27tc0FF7.js";import{s as T}from"./set-2Chj4B2I.js";import{v}from"./view-I-40yLKJ.js";import{w as ut}from"./withQueryClient.container-mPoqUoyy.js";import{s as M}from"./scrollErrorIntoView-6n4Cku1Y.js";import{c as gt,a as ie,n as le,p as pt,N as ft,t as mt,b as Ct,l as bt,d as St}from"./NodeBalancerCreate-jmk_SEg8.js";import{N as yt}from"./NodeBalancerDeleteDialog-vGZOjk5D.js";import{T as Q,a as L,b as Te,c as ve}from"./TableRow-phXfWUGW.js";import{T as jt}from"./TableRowEmpty-aXmC67-Z.js";import{T as xt}from"./TableRowError-8gKmGX7P.js";import{T as Nt}from"./TableRowLoading-iP7zIRHG.js";import{R as Tt}from"./RemoveDeviceDialog-748tKgS_.js";import{S as vt}from"./StatusIcon-RuV8PvAV.js";import{n as kt,g as wt,a as Lt}from"./FirewallRow-Z-AJ-hg4.js";import{I as Bt}from"./InlineMenuAction-d5mRENST.js";import{c as Dt}from"./shared-QcuPM2Px.js";import{T as ke}from"./TableHead-Si_pzkLK.js";import{T as Pt}from"./TagsPanel-CYEBNrGy.js";import{I as ce}from"./IPAddress-ZmG9OcMn.js";import{S as de}from"./pending-Ji4jJt0E.js";import{A as he}from"./AreaChart-dNVOmZtQ.js";import{L as ue}from"./LineGraph-UgU3EQj3.js";import{b as ge}from"./utilities-JekaXHyt.js";import{g as Y,f as Et}from"./statMetrics-2cM1lQIj.js";import"./assocPath-nNkv7F8U.js";import"./SelectRegionPanel-Y2ibm2gz.js";import"./RegionSelect-_Z8IGlox.js";import"./Autocomplete-XvrzKoAo.js";import"./Flag-kVTQNGw3.js";import"./ListItem-joIHQeyv.js";import"./visuallyHidden-DVicuktI.js";import"./RegionHelperText-N0L662HQ.js";import"./SelectFirewallPanel-xh9FN-rV.js";import"./CreateFirewallDrawer-dcf-B8xd.js";import"./formik.esm-Kap5lsIh.js";import"./Drawer-A9yKjC3Z.js";import"./LinodeSelect-y7DOgXsC.js";import"./NodeBalancerSelect-tPR8nvIa.js";import"./formikErrorUtils-jhqfCjwU.js";import"./grants-2yY1GgvJ.js";import"./LinkButton-O1af9aD7.js";import"./constants-KokzTiEs.js";import"./linodes-orSDvVk7.js";import"./TagsInput-cI8zXYga.js";import"./concat-Y0p1CSCT.js";import"./_isFunction-X3ooR5X_.js";import"./_contains-91K6xqrF.js";import"./tags-kBUFHmv1.js";import"./getAPIErrorFor-OfQrArkQ.js";import"./dynamicPricing-n5eCZqTg.js";import"./ipUtils-P4y3JNCT.js";import"./ipaddr-jlottelM.js";import"./Toggle-AbahDP9J.js";import"./TypeToConfirmDialog-9yjZCCL0.js";import"./TypeToConfirm-koQ3u5up.js";import"./Skeleton-iwmO4Yae.js";import"./ActionMenu-4CPisA_2.js";import"./CopyTooltip-mIyzAQ7E.js";import"./index-Y5esPPk-.js";import"./ShowMore-4P5e_z46.js";import"./PublicIpsUnassignedTooltip-A07mEsGp.js";import"./toInteger-N3RsDDMF.js";function At(n){return function(h){var t;return t=class extends x.Component{constructor(){super(...arguments);u(this,"handleDone",()=>{this.mounted&&this.setState(r=>({...r,loading:!1}))});u(this,"mounted",!1);u(this,"state",{loading:!0})}componentDidMount(){this.mounted=!0;const r=Object.entries(n).map(([o,d])=>d(this.props).then(i=>{this.mounted&&this.setState(c=>({...c,[o]:{response:i}}))}).catch(i=>{this.mounted&&this.setState(c=>({...c,[o]:{error:!0,response:i}}))}));Promise.all(r).then(this.handleDone).catch(this.handleDone)}componentWillUnmount(){this.mounted=!1}render(){const{loading:r,...o}=this.state;return r?e.jsx(ee,{"data-qa-circle-progress":!0}):e.jsx(h,{...this.props,...o})}},u(t,"displayName",`PromiseLoader(${h.displayName||h.name})`),t}}const It=N("span",{label:"StyledPortsSpan"})(({theme:n})=>({marginRight:n.spacing(2)})),Mt=N(k,{label:"StyledNBStatusesTypography"})(({theme:n})=>({display:"block",[n.breakpoints.up("sm")]:{display:"inline"}})),$t=N(H,{label:"StyledConfigsButton"})(({theme:n})=>({[n.breakpoints.down("lg")]:{marginLeft:n.spacing()}})),Rt=n=>_e(n).then(h=>Promise.all(h.data.map(t=>Ge(n,t.id).then(({data:s})=>({...t,nodes:St(s)}))))),Ft=n=>{const h=n.reduce((t,s)=>(s.status&&t[s.status]++,t),{DOWN:0,UP:0,unknown:0});return`Backend status: ${h.UP} up, ${h.DOWN} down${h.unknown?`, ${h.unknown} unknown`:""}`},w=class w extends x.Component{constructor(){super(...arguments);u(this,"addNode",t=>()=>{this.setState(T(D(["configs",t,"nodes"]),I(gt())(this.state.configs[t].nodes)))});u(this,"addNodeBalancerConfig",()=>{this.setState({configErrors:I([],this.state.configErrors),configSubmitting:I(!1,this.state.configSubmitting),configs:I(ie(!1),this.state.configs),hasUnsavedConfig:!0})});u(this,"afterHealthCheckTypeUpdate",t=>()=>{this.setState(A(T(t.checkBodyLens,w.defaultFieldsStates.configs[0].check_body),T(t.healthCheckAttemptsLens,w.defaultFieldsStates.configs[0].check_attempts),T(t.healthCheckIntervalLens,w.defaultFieldsStates.configs[0].check_interval),T(t.healthCheckTimeoutLens,w.defaultFieldsStates.configs[0].check_timeout)))});u(this,"afterProtocolUpdate",t=>()=>{this.setState(A(T(t.sslCertificateLens,""),T(t.privateKeyLens,"")))});u(this,"clearMessages",()=>{this.setState({panelMessages:[],panelNodeMessages:[]})});u(this,"clearNodeErrors",t=>{const s=this.state.configs[t].nodes.map((r,o)=>["nodes",o,"errors"]);if(s.length===0)return;const a=s.map(r=>T(D(["configs",t,...r]),[]));this.setState(A(...a))});u(this,"confirmationConfigError",()=>(this.state.deleteConfigConfirmDialog.errors||[]).map(t=>t.reason).join(","));u(this,"createNode",(t,s)=>{const{match:{params:{nodeBalancerId:a}}}=this.props,r=this.state.configs[t],o=this.state.configs[t].nodes[s],d=le(o);if(a&&!(!r||!r.id))return Pe(Number(a),r.id,d).then(i=>this.handleNodeSuccess(i,t,s)).catch(i=>this.handleNodeFailure(i,t,s))});u(this,"deleteConfig",()=>{const{deleteConfigConfirmDialog:{idxToDelete:t}}=this.state;if(t===void 0)return;const s=this.state.configs[t];if(s.modifyStatus==="new"){const r=j(this.state.configs);r.splice(t,1),this.setState({configs:r,deleteConfigConfirmDialog:j(w.defaultDeleteConfigConfirmDialogState),hasUnsavedConfig:!1});return}this.setState({deleteConfigConfirmDialog:{...this.state.deleteConfigConfirmDialog,errors:void 0,submitting:!0}});const{match:{params:{nodeBalancerId:a}}}=this.props;a&&(!s||!s.id||Ee(Number(a),s.id).then(r=>{this.props.queryClient.invalidateQueries([V,"nodebalancer",Number(a),"configs"]);const o=j(this.state.configs);o.splice(t,1),this.setState({configs:o,deleteConfigConfirmDialog:j(w.defaultDeleteConfigConfirmDialogState)})}).catch(r=>this.setState({deleteConfigConfirmDialog:{...this.state.deleteConfigConfirmDialog,errors:r,submitting:!1}},()=>{M(`${t}`)})))});u(this,"deleteNode",(t,s)=>{const{match:{params:{nodeBalancerId:a}}}=this.props;if(!a)return;const{configs:r}=this.state;if(!r)return;const o=r[t];if(!o||!o.id)return;const d=o.nodes[s];if(!(!d||!d.id))return Ae(Number(a),o.id,d.id).then(()=>(this.setState(z(D(["configs",t,"nodes"]),i=>i.filter((c,g)=>g!==s))),!0)).catch(i=>!1)});u(this,"fieldErrorsToNodePathErrors",t=>t.reduce((s,a)=>{const r=/^nodes\[(\d+)\].(\w+)$/.exec(a.field);return r&&r[1]&&r[2]?[...s,{error:{field:r[2],reason:a.reason},path:[+r[1],"errors"]}]:s},[]));u(this,"handleNodeFailure",(t,s,a)=>{const r=O(t);return this.updateNodeErrors(s,a,r),!1});u(this,"handleNodeSuccess",(t,s,a)=>(this.setState(T(D(["configs",s,"nodes",a]),pt(t))),!0));u(this,"onCloseConfirmation",()=>this.setState({deleteConfigConfirmDialog:{...this.state.deleteConfigConfirmDialog,open:!1}}));u(this,"onDeleteConfig",(t,s)=>()=>{this.setState({deleteConfigConfirmDialog:{...j(w.defaultDeleteConfigConfirmDialogState),idxToDelete:t,open:!0,portToDelete:s}})});u(this,"onNodeAddressChange",t=>(s,a)=>this.setNodeValue(t,s,"address",a));u(this,"onNodeLabelChange",t=>(s,a)=>this.setNodeValue(t,s,"label",a));u(this,"onNodeModeChange",t=>(s,a)=>{this.setNodeValue(t,s,"mode",a)});u(this,"onNodePortChange",t=>(s,a)=>this.setNodeValue(t,s,"port",a));u(this,"onNodeWeightChange",t=>(s,a)=>this.setNodeValue(t,s,"weight",a));u(this,"onSaveConfig",t=>()=>this.saveConfig(t));u(this,"removeNode",t=>s=>{this.clearMessages(),this.state.configs[t].nodes[s].id!==void 0?this.setState(T(D(["configs",t,"nodes",s,"modifyStatus"]),"delete")):this.setState(z(D(["configs",t,"nodes"]),a=>a.filter((r,o)=>o!==s)))});u(this,"renderConfig",(t,s,a)=>(r,o)=>{const d=this.state.hasUnsavedConfig&&o===this.state.configs.length-1,{panelNodeMessages:i}=this.state,c=bt(["configs",o]),g=this.props.match.params.configId,m=g?parseInt(g,10)===r.id:!1,l={algorithmLens:c(["algorithm"]),checkBodyLens:c(["check_body"]),checkPassiveLens:c(["check_passive"]),checkPathLens:c(["check_path"]),healthCheckAttemptsLens:c(["check_attempts"]),healthCheckIntervalLens:c(["check_interval"]),healthCheckTimeoutLens:c(["check_timeout"]),healthCheckTypeLens:c(["check"]),portLens:c(["port"]),privateKeyLens:c(["ssl_key"]),protocolLens:c(["protocol"]),proxyProtocolLens:c(["proxy_protocol"]),sessionStickinessLens:c(["stickiness"]),sslCertificateLens:c(["ssl_cert"])};return e.jsx($,{heading:e.jsxs(x.Fragment,{children:[e.jsxs(It,{children:["Port ",r.port!==void 0?r.port:""]}),e.jsx(Mt,{children:Ft(r.nodes)})]}),defaultExpanded:d||m,success:t[o],children:e.jsx(ft,{onHealthCheckAttemptsChange:this.updateStateWithClamp(l.healthCheckAttemptsLens),onHealthCheckIntervalChange:this.updateStateWithClamp(l.healthCheckIntervalLens),onHealthCheckTimeoutChange:this.updateStateWithClamp(l.healthCheckTimeoutLens),onHealthCheckTypeChange:this.updateState(l.healthCheckTypeLens,l,this.afterHealthCheckTypeUpdate),onProtocolChange:this.updateState(l.protocolLens,l,this.afterProtocolUpdate),addNode:this.addNode(o),algorithm:v(l.algorithmLens,this.state),checkBody:v(l.checkBodyLens,this.state),checkPassive:v(l.checkPassiveLens,this.state),checkPath:v(l.checkPathLens,this.state),configIdx:o,errors:s[o],forEdit:!0,healthCheckAttempts:v(l.healthCheckAttemptsLens,this.state),healthCheckInterval:v(l.healthCheckIntervalLens,this.state),healthCheckTimeout:v(l.healthCheckTimeoutLens,this.state),healthCheckType:v(l.healthCheckTypeLens,this.state),nodeBalancerRegion:this.props.nodeBalancerRegion,nodeMessage:i[o],nodes:r.nodes,onAlgorithmChange:this.updateState(l.algorithmLens),onCheckBodyChange:this.updateState(l.checkBodyLens),onCheckPassiveChange:this.updateState(l.checkPassiveLens),onCheckPathChange:this.updateState(l.checkPathLens),onDelete:this.onDeleteConfig(o,r.port),onNodeAddressChange:this.onNodeAddressChange(o),onNodeLabelChange:this.onNodeLabelChange(o),onNodeModeChange:this.onNodeModeChange(o),onNodePortChange:this.onNodePortChange(o),onNodeWeightChange:this.onNodeWeightChange(o),onPortChange:this.updateState(l.portLens),onPrivateKeyChange:this.updateState(l.privateKeyLens),onProxyProtocolChange:this.updateState(l.proxyProtocolLens),onSave:this.onSaveConfig(o),onSessionStickinessChange:this.updateState(l.sessionStickinessLens),onSslCertificateChange:this.updateState(l.sslCertificateLens),port:v(l.portLens,this.state),privateKey:v(l.privateKeyLens,this.state),protocol:v(l.protocolLens,this.state),proxyProtocol:v(l.proxyProtocolLens,this.state),removeNode:this.removeNode(o),sessionStickiness:v(l.sessionStickinessLens,this.state),sslCertificate:v(l.sslCertificateLens,this.state),submitting:a[o]})},`nb-config-${o}`)});u(this,"renderConfigConfirmationActions",({onClose:t})=>e.jsx(Ie,{primaryButtonProps:{"data-testid":"confirm-cancel",label:"Delete",loading:this.state.deleteConfigConfirmDialog.submitting,onClick:this.deleteConfig},secondaryButtonProps:{"data-testid":"cancel-cancel",label:"Cancel",onClick:t},style:{padding:0}}));u(this,"resetSubmitting",t=>{const s=j(this.state.configSubmitting);s[t]=!1,this.setState({configSubmitting:s})});u(this,"saveConfig",t=>{const s=this.state.configs[t],a=mt([s])[0];this.clearNodeErrors(t),this.clearMessages();const r=j(this.state.configSubmitting);r[t]=!0,this.setState({configSubmitting:r}),s.modifyStatus!=="new"?this.saveConfigUpdatePath(t,s,a):this.saveConfigNewPath(t,s,a)});u(this,"saveConfigNewPath",(t,s,a)=>{const{match:{params:{nodeBalancerId:r}}}=this.props;r&&Me(Number(r),a).then(o=>{this.props.queryClient.invalidateQueries([V,"nodebalancer",Number(r),"configs"]);const d=j(this.state.configs);d[t]={...o,nodes:[]};const i=j(this.state.configs[t].nodes);d[t].nodes=i;const c=j(this.state.configErrors);c[t]=[],this.setState({configErrors:c,configs:d},()=>{const g=[];g[t]="New NodeBalancer Configuration created successfully",this.setState({panelMessages:g}),this.setState({hasUnsavedConfig:!1});const m=s.nodes.map((l,S)=>l.modifyStatus!=="delete"?this.createNode(t,S):new Promise(f=>f(!0)));Promise.all([...m]).then(l=>{if(l.reduce((f,b)=>f&&b,!0)){const f=[];f[t]="All Nodes created successfully",this.setState({panelNodeMessages:f})}this.resetSubmitting(t)}).catch(l=>{this.resetSubmitting(t)})})}).catch(o=>{const d=O(o),i=j(this.state.configErrors);i[t]=d||[],this.setNodeErrors(t,i[t]),this.setState({configErrors:i},()=>{M(`${t}`)}),this.resetSubmitting(t)})});u(this,"saveConfigUpdatePath",(t,s,a)=>{const{match:{params:{nodeBalancerId:r}}}=this.props;if(!r||!s||!s.id)return;const o=$e(Number(r),s.id,a).then(i=>{this.props.queryClient.invalidateQueries([V,"nodebalancer",Number(r),"configs"]);const c=j(this.state.configs);c[t]={...i,nodes:[]};const g=j(this.state.configs[t].nodes);c[t].nodes=g;const m=j(this.state.configErrors);m[t]=[];const l=j(this.state.configSubmitting);return l[t]=!1,this.setState({configErrors:m,configSubmitting:l,configs:c}),!0}).catch(i=>{const c=O(i),g=j(this.state.configErrors);return g[t]=c||[],this.setState({configErrors:g},()=>{M(`${t}`)}),this.resetSubmitting(t),!1}),d=s.nodes.map((i,c)=>i.modifyStatus==="delete"?this.deleteNode(t,c):i.modifyStatus==="new"?this.createNode(t,c):i.modifyStatus==="update"?this.updateNode(t,c):new Promise(g=>g(void 0)));Promise.all([o,...d]).then(i=>{const[c,...g]=i;if(c){const l=[];l[t]="NodeBalancer Configuration updated successfully",this.setState({panelMessages:l})}const m=g.filter(l=>l!==void 0);if(m.length&&m.reduce((S,f)=>S&&f,!0)){const S=[];S[t]="All Nodes updated successfully",this.setState({panelNodeMessages:S})}this.resetSubmitting(t)}).catch(i=>{this.resetSubmitting(t)})});u(this,"setNodeErrors",(t,s)=>{const a=this.fieldErrorsToNodePathErrors(s);if(a.length===0)return;const r=a.map(o=>A(z(D(["configs",t,"nodes",...o.path]),I(o.error)),Re([])));this.setState(A(...r),()=>{M(`${t}`)})});u(this,"setNodeValue",(t,s,a,r)=>{this.clearMessages();const{modifyStatus:o}=this.state.configs[t].nodes[s];o==="new"||o==="delete"||this.setState(T(D(["configs",t,"nodes",s,"modifyStatus"]),"update")),this.setState(T(D(["configs",t,"nodes",s,a]),r))});u(this,"state",{configErrors:[],configSubmitting:[],configs:Fe([],["response"],this.props.configs),deleteConfigConfirmDialog:j(w.defaultDeleteConfigConfirmDialogState),hasUnsavedConfig:!1,panelMessages:[],panelNodeMessages:[]});u(this,"updateNode",(t,s)=>{const{match:{params:{nodeBalancerId:a}}}=this.props,r=this.state.configs[t],o=this.state.configs[t].nodes[s],d=le(o);if(a&&!(!r||!r.id)&&!(!o||!o.id))return Ue(Number(a),r.id,o.id,d).then(i=>this.handleNodeSuccess(i,t,s)).catch(i=>this.handleNodeFailure(i,t,s))});u(this,"updateNodeErrors",(t,s,a)=>{this.setState(T(D(["configs",t,"nodes",s,"errors"]),a),()=>{M(`${t}`)})});u(this,"updateState",(t,s,a)=>r=>{this.clearMessages(),this.setState(T(t,r),s&&a?a(s):void 0)});u(this,"updateStateWithClamp",(t,s,a)=>r=>{const o=Ct(0,Number.MAX_SAFE_INTEGER)(r);this.updateState(t,s,a)(o)})}render(){const{nodeBalancerLabel:t}=this.props,{configErrors:s,configSubmitting:a,configs:r,hasUnsavedConfig:o,panelMessages:d}=this.state;return e.jsxs("div",{children:[e.jsx(te,{segment:`${t} - Configurations`}),Array.isArray(r)&&r.map(this.renderConfig(d,s,a)),!o&&e.jsx(W,{sx:{marginTop:"16px"},children:e.jsx($t,{buttonType:"outlined","data-qa-add-config":!0,onClick:()=>this.addNodeBalancerConfig(),children:r.length===0?"Add a Configuration":"Add Another Configuration"})}),e.jsx(De,{title:typeof this.state.deleteConfigConfirmDialog.portToDelete<"u"?`Delete this configuration on port ${this.state.deleteConfigConfirmDialog.portToDelete}?`:"Delete this configuration?",actions:this.renderConfigConfirmationActions,error:this.confirmationConfigError(),onClose:this.onCloseConfirmation,open:this.state.deleteConfigConfirmDialog.open,children:e.jsx(k,{children:"Are you sure you want to delete this NodeBalancer Configuration?"})})]})}};u(w,"defaultDeleteConfigConfirmDialogState",{errors:void 0,idxToDelete:void 0,open:!1,portToDelete:void 0,submitting:!1}),u(w,"defaultDeleteNodeConfirmDialogState",{configIdxToDelete:void 0,errors:void 0,nodeIdxToDelete:void 0,open:!1,submitting:!1}),u(w,"defaultFieldsStates",{configs:[ie(!0)]});let Z=w;const Ut=At({configs:n=>{const{match:{params:{nodeBalancerId:h}}}=n;return Rt(+h)}}),qt=Be(qe,Ut,ut),_t=qt(Z),Gt=n=>{const{firewallID:h,onUnassign:t}=n,{data:s}=je(),{data:a}=He(),o=Dt(h,s,a)?{}:{disabled:!0,tooltip:kt},d={onClick:()=>{t()},title:"Unassign",...o};return e.jsx(Bt,{actionText:d.title,"data-qa-linode-firewalls-action-menu":!0,disabled:d.disabled,onClick:d.onClick},d.title)},Ht=n=>{const{firewall:h,nodeBalancerID:t,onClickUnassign:s}=n,{id:a,label:r,rules:o,status:d}=h,{data:i}=Oe(a),c=i==null?void 0:i.find(m=>m.entity.type==="nodebalancer"&&m.entity.id===t),g=wt(o);return e.jsxs(Q,{ariaLabel:`Firewall ${r}`,"data-qa-linode-firewall-row":!0,children:[e.jsx(L,{"data-qa-firewall-label":!0,children:e.jsx(J,{tabIndex:0,to:`/firewalls/${a}`,children:r})}),e.jsxs(L,{"data-qa-firewall-status":!0,statusCell:!0,children:[e.jsx(vt,{status:d==="enabled"?"active":"inactive"}),We(d)]}),e.jsx(L,{"data-qa-firewall-rules":!0,children:Lt(g)}),e.jsx(L,{actionCell:!0,children:e.jsx(Gt,{firewallID:a,onUnassign:()=>s(c,h)})})]},`firewall-${a}`)},Ot=n=>{const{displayFirewallInfoText:h,nodeBalancerId:t}=n,{data:s,error:a,isLoading:r}=se(t),o=s==null?void 0:s.data,[d,i]=x.useState(),[c,g]=x.useState(),[m,l]=x.useState(!1),S=(C,p)=>{g(C),i(p),l(!0)},f=()=>{var C;return r?e.jsx(Nt,{columns:4,rows:1}):a?e.jsx(xt,{colSpan:5,message:(C=a==null?void 0:a[0])==null?void 0:C.reason}):(o==null?void 0:o.length)===0||o===void 0?e.jsx(jt,{colSpan:5,message:"No Firewalls are assigned."}):o.map(p=>e.jsx(Ht,{firewall:p,nodeBalancerID:t,onClickUnassign:S},`firewall-${p.id}`))},b=e.jsx(oe,{to:Qe,children:"Learn more about creating Firewalls."}),y=e.jsx(oe,{to:"/firewalls/",children:"Firewalls"});return e.jsxs(Ke,{sx:{marginTop:"0px"},children:[e.jsx(W,{display:"flex",children:h?e.jsxs(k,{sx:C=>({marginBottom:C.spacing()}),"data-testid":"nodebalancer-firewalls-table-header",children:["If you want to assign a new Firewall to this NodeBalancer, go to"," ",y,".",e.jsx("br",{}),b]}):null}),e.jsxs(Te,{children:[e.jsx(ke,{children:e.jsxs(Q,{children:[e.jsx(L,{children:"Firewall"}),e.jsx(L,{children:"Status"}),e.jsx(L,{children:"Rules"}),e.jsx(L,{})]})}),e.jsx(ve,{children:f()})]}),e.jsx(Tt,{device:c,firewallId:(d==null?void 0:d.id)??-1,firewallLabel:(d==null?void 0:d.label)??"",onClose:()=>l(!1),onService:!0,open:m})]})},Wt=()=>{const n=ae(),h=xe(),{nodeBalancerId:t}=F(),s=Number(t),{data:a}=U(s),{data:r}=se(s),o=(r==null?void 0:r.results)===0,{error:d,isLoading:i,mutateAsync:c}=K(s),{error:g,isLoading:m,mutateAsync:l}=K(s),[S,f]=x.useState(!1),[b,y]=x.useState(a==null?void 0:a.label),[C,p]=x.useState(a==null?void 0:a.client_conn_throttle);if(x.useEffect(()=>{b!==(a==null?void 0:a.label)&&y(a==null?void 0:a.label),C!==(a==null?void 0:a.client_conn_throttle)&&p(a==null?void 0:a.client_conn_throttle)},[a]),!a)return null;const B={marginTop:h.spacing()};return e.jsxs("div",{children:[e.jsx(te,{segment:`${a.label} - Settings`}),e.jsxs($,{defaultExpanded:!0,heading:"NodeBalancer Label",children:[e.jsx(re,{"data-qa-label-panel":!0,errorText:d==null?void 0:d[0].reason,label:"Label",onChange:E=>y(E.target.value),placeholder:"Enter a label between 3 and 32 characters",value:b}),e.jsx(H,{buttonType:"primary","data-qa-label-save":!0,disabled:b===a.label,loading:i,onClick:()=>c({label:b}),sx:B,children:"Save"})]}),n.firewallNodebalancer&&e.jsx($,{defaultExpanded:!0,heading:"Firewalls",children:e.jsx(Ot,{displayFirewallInfoText:o,nodeBalancerId:s})}),e.jsxs($,{defaultExpanded:!0,heading:"Client Connection Throttle",children:[e.jsx(re,{InputProps:{endAdornment:e.jsx(Ve,{position:"end",children:"/ second"})},"data-qa-connection-throttle":!0,errorText:g==null?void 0:g[0].reason,label:"Connection Throttle",onChange:E=>p(Number(E.target.value)),placeholder:"0",type:"number",value:C}),e.jsx(Xe,{children:"To help mitigate abuse, throttle connections from a single client IP to this number per second. 0 to disable."}),e.jsx(H,{onClick:()=>l({client_conn_throttle:C}),buttonType:"primary","data-qa-label-save":!0,disabled:C===a.client_conn_throttle,loading:m,sx:B,children:"Save"})]}),e.jsx($,{defaultExpanded:!0,heading:"Delete NodeBalancer",children:e.jsx(H,{buttonType:"primary",onClick:()=>f(!0),children:"Delete"})}),e.jsx(yt,{id:a.id,label:a==null?void 0:a.label,onClose:()=>f(!1),open:S})]})},Kt=()=>{var b,y,C;const n=ae(),{nodeBalancerId:h}=F(),t=Number(h),{data:s}=U(t),{data:a}=ze(t),{data:r}=Ye(),{data:o}=se(t),d=(b=o==null?void 0:o.data[0])==null?void 0:b.label,i=(y=o==null?void 0:o.data[0])==null?void 0:y.id,c=r==null?void 0:r.find(p=>p.id===(s==null?void 0:s.region)),{mutateAsync:g}=K(t),m=!!((C=o==null?void 0:o.data)!=null&&C.length),l=a==null?void 0:a.reduce((p,B)=>[...p,{configId:B.id,port:B.port}],[]),S=a==null?void 0:a.reduce((p,B)=>p+B.nodes_status.down,0),f=a==null?void 0:a.reduce((p,B)=>p+B.nodes_status.up,0);return!s||!a?null:e.jsxs(Qt,{children:[e.jsx(Vt,{children:e.jsxs(q,{children:[e.jsx(_,{"data-qa-title":!0,variant:"h3",children:"NodeBalancer Details"}),e.jsx(P,{children:e.jsxs(k,{"data-qa-ports":!0,variant:"body1",children:[e.jsx("strong",{children:"Ports: "}),(l==null?void 0:l.length)===0&&"None",l==null?void 0:l.map(({configId:p,port:B},E)=>e.jsxs(x.Fragment,{children:[e.jsx(J,{className:"secondaryLink",to:`/nodebalancers/${s==null?void 0:s.id}/configurations/${p}`,children:B}),E<(l==null?void 0:l.length)-1?", ":""]},p))]})}),e.jsx(P,{children:e.jsxs(k,{variant:"body1",children:[e.jsx("strong",{children:"Backend Status: "}),`${f} up, ${S} down`]})}),e.jsx(P,{children:e.jsxs(k,{variant:"body1",children:[e.jsx("strong",{children:"Transferred: "}),Je(s.transfer.total)]})}),e.jsx(P,{children:e.jsxs(k,{style:{wordBreak:"break-word"},variant:"body1",children:[e.jsx("strong",{children:"Host Name: "}),s.hostname]})}),e.jsx(P,{children:e.jsxs(k,{"data-qa-region":!0,variant:"body1",children:[e.jsx("strong",{children:"Region:"})," ",c==null?void 0:c.label]})})]})}),m&&n.firewallNodebalancer&&e.jsxs(q,{children:[e.jsx(_,{"data-qa-title":!0,variant:"h3",children:"Firewall"}),e.jsx(k,{"data-qa-firewall":!0,variant:"body1",children:e.jsx(J,{className:"secondaryLink",to:`/firewalls/${i}`,children:d})})]}),e.jsxs(q,{children:[e.jsx(_,{"data-qa-title":!0,variant:"h3",children:"IP Addresses"}),e.jsx(P,{children:e.jsxs(Xt,{"data-qa-ip":!0,children:[(s==null?void 0:s.ipv4)&&e.jsx(ce,{ips:[s==null?void 0:s.ipv4],isHovered:!0,showMore:!0}),(s==null?void 0:s.ipv6)&&e.jsx(ce,{ips:[s==null?void 0:s.ipv6],isHovered:!0})]})})]}),e.jsxs(q,{children:[e.jsx(_,{"data-qa-title":!0,variant:"h3",children:"Tags"}),e.jsx(Pt,{tags:s==null?void 0:s.tags,updateTags:p=>g({tags:p})})]})]})},Qt=N("div",{label:"StyledRootDiv"})(({theme:n})=>({paddingTop:n.spacing()})),Vt=N("div",{label:"StyledSummarySectionWrapper"})(({theme:n})=>({[n.breakpoints.up("md")]:{marginTop:n.spacing(6)}})),q=N(Ne,{label:"StyledSummarySection"})(({theme:n})=>({height:"93%",marginBottom:n.spacing(2),minHeight:"160px",padding:n.spacing(2.5)})),_=N(k,{label:"StyledTitle"})(({theme:n})=>({marginBottom:n.spacing(2)})),P=N("div",{label:"StyledSection"})(({theme:n})=>({marginBottom:n.spacing(1),...n.typography.body1,"& .dif":{"& .chip":{position:"absolute",right:-10,top:"-4px"},position:"relative",width:"auto"}})),Xt=N("div",{label:"StyledIPGrouping"})(()=>({display:"flex",flexDirection:"column",margin:"-2px 0 0 2px"})),zt=Ze()(n=>({blue:{"&:before":{backgroundColor:n.graphs.blue}},darkGreen:{"&:before":{backgroundColor:n.graphs.network.inbound}},green:{"&:before":{backgroundColor:n.graphs.green}},legend:{"& > div":{"&:before":{content:'""',display:"inline-block",height:20,marginRight:n.spacing(1),width:20},alignItems:"center",display:"flex"}},lightGreen:{"&:before":{backgroundColor:n.graphs.network.outbound}},purple:{"&:before":{backgroundColor:n.graphs.purple}},red:{"&:before":{backgroundColor:n.graphs.red}},root:{border:`1px solid ${n.borderColors.borderTable}`},yellow:{"&:before":{backgroundColor:n.graphs.yellow}}})),pe=({rows:n})=>{const h=["Max","Avg","Last"],{classes:t}=zt();return e.jsxs(Te,{"aria-label":"Stats and metrics",className:t.root,children:[e.jsx(ke,{sx:{borderTop:"none !important"},children:e.jsxs(Q,{sx:{borderTop:"none !important"},children:[e.jsx(L,{sx:{borderTop:"none !important"},children:""}),h.map((s,a)=>e.jsx(L,{"data-qa-header-cell":!0,sx:{borderTop:"none !important"},children:s},a))]})}),e.jsx(ve,{children:n.map(s=>{const{data:a,format:r,legendColor:o,legendTitle:d}=s;return e.jsxs(Q,{"data-qa-metric-row":!0,children:[e.jsx(L,{className:t.legend,children:e.jsx("div",{className:t[o],"data-testid":"legend-title",children:e.jsx(k,{component:"span",children:d})})}),Yt(a).map((i,c)=>e.jsx(L,{"data-qa-body-cell":!0,parentColumn:h[c],children:r(i)},c))]},d)})})]})},Yt=n=>[n.max,n.average,n.last],fe="Stats for this NodeBalancer are not available yet",Jt=()=>{const n=xe(),{data:h}=je(),t=et(h==null?void 0:h.timezone),{nodeBalancerId:s}=F(),a=Number(s),{data:r}=U(a),{data:o,error:d,isLoading:i}=tt((r==null?void 0:r.id)??-1,r==null?void 0:r.created),c=ae(),g=d?O(d,"Unable to load stats")[0].reason:void 0,m=g===st,l=()=>{const f=(o==null?void 0:o.data.connections)??[];if(m)return e.jsx(R,{errorText:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsx(G,{variant:"h2",children:fe})}),e.jsx("div",{children:e.jsx(G,{variant:"body1",children:"Connection stats will be available shortly"})})]}),CustomIcon:de,CustomIconStyles:{height:64,width:64}});if(g&&!m)return e.jsx(R,{errorText:g});if(i)return e.jsx(ye,{});const b=Y(f);let y=[];return c.recharts&&(y=f.reduce((C,p)=>(C.push({Connections:p[1],t:p[0]}),C),[])),e.jsxs(x.Fragment,{children:[c.recharts?e.jsx(W,{marginLeft:-3,children:e.jsx(he,{areas:[{color:n.graphs.purple,dataKey:"Connections"}],xAxis:{tickFormat:"hh a",tickGap:60},"aria-label":"Connections Graph",data:y,height:300,timezone:t,unit:"CXN"})}):e.jsx(Ce,{children:e.jsx(ue,{data:[{backgroundColor:n.graphs.purple,borderColor:"transparent",data:f,label:"Connections"}],accessibleDataTable:{unit:"CXN/s"},ariaLabel:"Connections Graph",showToday:!0,timezone:t})}),e.jsx(be,{children:e.jsx(pe,{rows:[{data:b,format:Et,legendColor:"purple",legendTitle:"Connections"}]})})]})},S=()=>{const f=(o==null?void 0:o.data.traffic.in)??[],b=(o==null?void 0:o.data.traffic.out)??[],y=[];if(c.recharts&&f)for(let C=0;C<f.length;C++)y.push({"Traffic In":f[C][1],"Traffic Out":b[C][1],t:f[C][0]});return m?e.jsx(R,{errorText:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsx(G,{variant:"h2",children:fe})}),e.jsx("div",{children:e.jsx(G,{variant:"body1",children:"Traffic stats will be available shortly"})})]}),CustomIcon:de,CustomIconStyles:{height:64,width:64}}):g&&!m?e.jsx(R,{errorText:g}):i?e.jsx(ye,{}):e.jsxs(x.Fragment,{children:[e.jsx(Ce,{children:c.recharts?e.jsx(W,{marginLeft:-4,children:e.jsx(he,{areas:[{color:n.graphs.network.inbound,dataKey:"Traffic In"},{color:n.graphs.network.outbound,dataKey:"Traffic Out"}],xAxis:{tickFormat:"hh a",tickGap:60},"aria-label":"Traffic Graph",data:y,height:300,timezone:t,unit:"bits"})}):e.jsx(ue,{data:[{backgroundColor:n.graphs.network.inbound,borderColor:"transparent",data:f,label:"Traffic In"},{backgroundColor:n.graphs.network.outbound,borderColor:"transparent",data:b,label:"Traffic Out"}],accessibleDataTable:{unit:"bits/s"},ariaLabel:"Traffic Graph",showToday:!0,timezone:t})}),e.jsx(be,{children:e.jsx(pe,{rows:[{data:Y(f),format:ge,legendColor:"darkGreen",legendTitle:"Inbound"},{data:Y(b),format:ge,legendColor:"lightGreen",legendTitle:"Outbound"}]})})]})};return e.jsxs(x.Fragment,{children:[e.jsx(Zt,{variant:"h2",children:"Graphs"}),e.jsxs(Se,{children:[e.jsx(me,{variant:"h3",children:"Connections (CXN/s, 5 min avg.)"}),l()]}),e.jsxs(Se,{children:[e.jsx(me,{variant:"h3",children:"Traffic (bits/s, 5 min avg.)"}),S()]})]})},me=N(k,{label:"StyledHeader"})(({theme:n})=>({padding:n.spacing(2)})),Zt=N(k,{label:"StyledTitle"})(({theme:n})=>({alignItems:"center",display:"flex",[n.breakpoints.down("lg")]:{marginLeft:n.spacing()},[n.breakpoints.up("md")]:{margin:`${n.spacing(2)} 0`}})),Ce=N("div",{label:"StyledChart"})(({theme:n})=>({paddingLeft:n.spacing(1),position:"relative",width:"100%"})),be=N("div",{label:"StyledBottomLegend"})(({theme:n})=>({backgroundColor:n.bg.offWhite,color:"#777",fontSize:14,margin:`${n.spacing(2)} ${n.spacing(1)} ${n.spacing(1)}`})),Se=N(Ne,{label:"StyledPanel"})(({theme:n})=>({marginTop:n.spacing(2),padding:n.spacing(2)})),G=N(k,{label:"StyledEmptyText"})(({theme:n})=>({marginTop:n.spacing(),textAlign:"center"})),ye=()=>e.jsx("div",{style:{alignItems:"center",display:"flex",justifyContent:"center",minHeight:300},children:e.jsx(ee,{mini:!0})}),es=()=>{const{nodeBalancerId:n}=F(),h=Number(n),{data:t}=U(h);return e.jsxs("div",{children:[e.jsx(te,{segment:`${t==null?void 0:t.label} - Summary`}),e.jsxs(ne,{container:!0,spacing:2,children:[e.jsx(ts,{lg:9,md:8,xs:12,children:e.jsx(Jt,{})}),e.jsx(ss,{lg:3,md:4,xs:12,children:e.jsx(Kt,{})})]})]})},ts=N(ne,{label:"StyledMainGridItem"})(({theme:n})=>({[n.breakpoints.up("md")]:{order:1}})),ss=N(ne,{label:"StyledSidebarGridItem"})(({theme:n})=>({[n.breakpoints.up("md")]:{order:2}})),Sa=()=>{const n=at(),h=nt(),{nodeBalancerId:t}=F(),s=Number(t),[a,r]=x.useState(),{error:o,mutateAsync:d}=K(s),{data:i,error:c,isLoading:g}=U(s);x.useEffect(()=>{a!==(i==null?void 0:i.label)&&r(i==null?void 0:i.label)},[i]);const m=()=>{r(i==null?void 0:i.label)},l=[{routeName:`/nodebalancers/${s}/summary`,title:"Summary"},{routeName:`/nodebalancers/${s}/configurations`,title:"Configurations"},{routeName:`/nodebalancers/${s}/settings`,title:"Settings"}],S=p=>!!it(h.pathname,{path:p});if(g)return e.jsx(ee,{});if(c)return e.jsx(R,{errorText:"There was an error retrieving your NodeBalancer. Please reload and try again."});if(!i)return null;const f=ot(["label"],o),b=f.label,y=a!==void 0?a:i==null?void 0:i.label,C=p=>{n.push(l[p].routeName)};return e.jsxs(x.Fragment,{children:[e.jsx(lt,{breadcrumbProps:{firstAndLastOnly:!0,onEditHandlers:{editableTextTitle:y,errorText:b,onCancel:m,onEdit:p=>d({label:p})},pathname:`/nodebalancers/${y}`},docsLabel:"Docs",docsLink:"https://www.linode.com/docs/guides/getting-started-with-nodebalancers/",title:y}),f.none&&e.jsx(rt,{text:f.none,variant:"error"}),e.jsxs(dt,{index:Math.max(l.findIndex(p=>S(p.routeName)),0),onChange:C,children:[e.jsx(ct,{tabs:l}),e.jsxs(ht,{children:[e.jsx(X,{index:0,children:e.jsx(es,{})}),e.jsx(X,{index:1,children:e.jsx(_t,{nodeBalancerLabel:i.label,nodeBalancerRegion:i.region})}),e.jsx(X,{index:2,children:e.jsx(Wt,{})})]})]})]})};export{Sa as NodeBalancerDetail};
