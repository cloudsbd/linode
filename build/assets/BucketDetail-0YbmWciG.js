import{s as b,T,j as e,r as C,cH as Y,f as Te,lH as Oe,bB as Fe,ag as Z,ao as Le,ap as Ie,lu as B,co as ee,a1 as ve,$ as Ne,lI as Ae,lJ as Ee,aW as te,bD as ae,G as L,lK as ne,V as Be,W as $,B as se,a_ as Pe,O as Me,e as Re,u as ze,cx as $e,bg as We,av as _e,lL as Ue,aj as Qe,af as He,lr as q,lM as qe,ls as Ge,lN as Ke,l6 as G,lO as Je,i3 as Ve}from"./index-Eksrs3uK.js";import{p as Xe}from"./immer.esm--MpJ8fpr.js";import{W as Ye}from"./index-C8Ov-8_e.js";import{a as y,T as W,b as Ze,c as et}from"./TableRow-phXfWUGW.js";import{O as tt,b as at}from"./ObjectUploader-HVL1-uVl.js";import{p as nt,i as oe,a as st,d as z,g as ot,t as rt}from"./utilities-12-n12_Y.js";import{u as re}from"./useWindowDimensions-Dnr94FWA.js";import{C as le}from"./CopyTooltip-mIyzAQ7E.js";import{u as lt}from"./formik.esm-Kap5lsIh.js";import{D as ie}from"./Drawer-A9yKjC3Z.js";import{A as it}from"./AccessSelect-HbZAM-Pg.js";import{T as K}from"./TableRowEmpty-aXmC67-Z.js";import{T as ct}from"./TableRowError-8gKmGX7P.js";import{T as J}from"./TableRowLoading-iP7zIRHG.js";import{A as ce}from"./ActionMenu-4CPisA_2.js";import{I as de}from"./InlineMenuAction-d5mRENST.js";import{D as dt}from"./DateTimeDisplay-bXC9mIcz.js";import{T as mt}from"./TableHead-Si_pzkLK.js";import"./index-Y5esPPk-.js";import"./Toggle-AbahDP9J.js";import"./useOpenClose-GWPIoKTB.js";import"./Skeleton-iwmO4Yae.js";const ut=b("div",{label:"StyledRootContainer"})(()=>({alignItems:"center",display:"flex",position:"relative"})),pt=b("div",{label:"StyledPrefixWrapper"})(({theme:t})=>({display:"flex",overflow:"auto",padding:`${t.spacing(1)} ${t.spacing(1)}`,whiteSpace:"nowrap",[t.breakpoints.down("lg")]:{marginLeft:t.spacing(1)}})),V=b(T,{label:"StyledSlash"})(()=>({marginLeft:4,marginRight:4})),X=b(T,{label:"StyledLink"})(({theme:t})=>({"&:hover":{textDecoration:"underline"},color:t.textColors.linkActiveLight,cursor:"pointer",fontSize:16})),ht=b(le,{label:"StyledCopyTooltip"})(({theme:t})=>({borderRadius:t.shape.borderRadius,paddingTop:t.spacing(1),svg:{height:16,width:16}})),xt=t=>{const{bucketName:r,history:d,prefix:m}=t,{width:s}=re(),n=r+"/"+m,a=m.split("/").filter(o=>o!==""),c=s<=600&&a.length>=3||a.length>5;return e.jsxs(ut,{children:[e.jsxs(pt,{children:[e.jsx(X,{onClick:()=>{d.push({search:"?prefix="})},variant:"body1",children:r}),c&&e.jsx(V,{variant:"body1",children:"/ ..."}),a.map((o,h)=>c&&h<a.length-3?null:e.jsxs(C.Fragment,{children:[e.jsx(V,{variant:"body1",children:"/"}),e.jsx(X,{onClick:()=>{if(h===a.length-1)return;const x=nt(a,h);d.push({search:"?prefix="+x})},variant:"body1",children:o})]},h))]}),e.jsx(ht,{text:n,placement:"bottom"})]})},bt=b(y,{label:"StyledNameColumn"})(()=>({width:"50%"})),jt=b(y,{label:"StyledSizeColumn"})(()=>({width:"10%"})),ft=b(Y,{label:"StyledTryAgain"})(()=>({textDecoration:"underline"})),yt=b(Te,{label:"StyledCreateFolderButton"})(({theme:t})=>({[t.breakpoints.down("md")]:{marginRight:t.spacing()}})),gt=b(T,{label:"StyledErrorFooter"})(({theme:t})=>({color:t.color.red})),Ct=b(T,{label:"StyledFooter"})(({theme:t})=>({color:t.palette.primary.main,cursor:"pointer",textDecoration:"underline"})),Dt=t=>{var f;const{bucketName:r,clusterId:d,maybeAddObjectToTable:m,onClose:s,open:n,prefix:a}=t,{error:c,isLoading:o,mutateAsync:h}=Oe(d,r),x=lt({initialValues:{name:""},async onSubmit({name:D},p){const I=a+D+"/",{exists:P,url:v}=await h({method:"PUT",name:I,options:{content_type:"application/octet-stream"}});if(P){p.setFieldError("name","This folder already exists.");return}fetch(v,{headers:{"Content-Type":"application/octet-stream"},method:"PUT"}),m(I,0),s()},validate(D){return D.name===""?{name:"Folder name required."}:{}}});return C.useEffect(()=>{n&&x.resetForm()},[n]),e.jsx(ie,{onClose:s,open:n,title:"Create Folder",children:e.jsxs("form",{onSubmit:x.handleSubmit,children:[e.jsx(Fe,{errorText:x.errors.name??((f=c==null?void 0:c[0])==null?void 0:f.reason),label:"Folder Name",name:"name",onChange:x.handleChange}),e.jsx(Z,{primaryButtonProps:{label:"Create",loading:o,type:"submit"},secondaryButtonProps:{label:"Cancel",onClick:s}})]})})},St=C.memo(t=>{const{data:r}=Le(),{bucketName:d,clusterId:m,displayName:s,lastModified:n,name:a,onClose:c,open:o,size:h,url:x}=t;let f;try{n&&(f=Ie(n,{timezone:r==null?void 0:r.timezone}))}catch{}return e.jsxs(ie,{onClose:c,open:o,title:B(s??"Object Detail"),children:[h?e.jsx(T,{variant:"subtitle2",children:ee(h).formatted}):null,f&&r?e.jsxs(T,{"data-testid":"lastModified",variant:"subtitle2",children:["Last modified: ",f]}):null,x?e.jsxs(kt,{children:[e.jsx(ve,{external:!0,to:x,children:B(x,50)}),e.jsx(wt,{sx:{marginLeft:4},text:x})]}):null,o&&a?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{spacingBottom:16,spacingTop:16}),e.jsx(it,{updateAccess:D=>Ae(m,d,a,D),getAccess:()=>Ee(m,d,a),name:a,variant:"object"})]}):null]})}),wt=b(le,{label:"StyledCopyTooltip"})(()=>({marginLeft:"1em",padding:0})),kt=b("div",{label:"StyledLinkContainer"})(()=>({display:"flex"})),Tt=t=>{const r=te(),d=ae(r.breakpoints.down("md")),{handleClickDelete:m,objectName:s}=t,n=[{onClick:()=>{m(s)},title:"Delete"}];return e.jsx(e.Fragment,{children:d?e.jsx(ce,{actionsList:n,ariaLabel:`Action menu for Folder ${s}`}):n.map(a=>e.jsx(de,{actionText:a.title,onClick:a.onClick},a.title))})},Ot=t=>{const{displayName:r,folderName:d,handleClickDelete:m}=t;return e.jsxs(W,{ariaLabel:`Folder ${r}`,...t,children:[e.jsx(y,{parentColumn:"Object",children:e.jsxs(L,{alignItems:"center",container:!0,spacing:2,wrap:"nowrap",children:[e.jsx(Ft,{children:e.jsx(ne,{size:22,variant:"folder"})}),e.jsx(L,{children:e.jsx(Be,{className:"secondaryLink",to:`?prefix=${d}`,children:r})})]})}),e.jsx(y,{}),e.jsx($,{mdDown:!0,children:e.jsx(y,{})}),e.jsx(y,{actionCell:!0,children:e.jsx(Tt,{handleClickDelete:m,objectName:d})})]},d)},Ft=b(L,{label:"StyledIconWrapper"})(()=>({margin:"2px 0"})),Lt=t=>{const r=te(),d=ae(r.breakpoints.down("md")),{handleClickDelete:m,handleClickDownload:s,objectName:n}=t,a=[{onClick:()=>{s(n,!0)},title:"Download"},{onClick:()=>{m(n)},title:"Delete"}];return e.jsx(e.Fragment,{children:d?e.jsx(ce,{actionsList:a,ariaLabel:`Action menu for Object ${n}`}):a.map(c=>e.jsx(de,{actionText:c.title,onClick:c.onClick},c.title))})},It=t=>{const{displayName:r,fullName:d,handleClickDelete:m,handleClickDetails:s,handleClickDownload:n,objectLastModified:a,objectSize:c}=t;return e.jsxs(W,{ariaLabel:r,children:[e.jsx(y,{children:e.jsxs(L,{alignItems:"center",container:!0,spacing:2,wrap:"nowrap",children:[e.jsx(L,{className:"py0",children:e.jsx(vt,{size:20,variant:"object",...t})}),e.jsx(L,{children:e.jsx(se,{alignItems:"center",display:"flex",children:e.jsx(T,{children:e.jsx(Y,{onClick:s,children:r})})})})]})}),e.jsx(y,{noWrap:!0,children:ee(c).formatted}),e.jsx($,{mdDown:!0,children:e.jsx(y,{noWrap:!0,children:e.jsx(dt,{value:a})})}),e.jsx(y,{actionCell:!0,children:e.jsx(Lt,{handleClickDelete:m,handleClickDownload:n,objectName:d})})]})},vt=b(ne,{label:"StyledEntityIcon"})(({theme:t,...r})=>({...r.manuallyCreated&&{"& g":{fill:t.bg.lightBlue1}}})),Nt=t=>{const{data:r,error:d,handleClickDelete:m,handleClickDetails:s,handleClickDownload:n,isFetching:a,isFetchingNextPage:c,numOfDisplayedObjects:o,prefix:h}=t,{width:x}=re();if(a&&!c)return e.jsx(J,{columns:4,responsive:{2:{mdDown:!0}}});if(d)return e.jsx(ct,{colSpan:6,message:"We were unable to load your Objects."});if(o===0)return e.jsx(K,{colSpan:6,message:h?"This folder is empty.":"This bucket is empty."});const f=x<600?20:40;return e.jsxs(e.Fragment,{children:[r.map(D=>D.data.map(p=>oe(p)?o===1?e.jsx(K,{colSpan:6,message:"This folder is empty."},`empty-${p.name}`):null:st(p)?e.jsx(Ot,{displayName:Pe(z(p.name),f),folderName:p.name,handleClickDelete:m,manuallyCreated:!1},p.name):e.jsx(It,{displayName:B(z(p.name),f),fullName:p.name,handleClickDelete:m,handleClickDetails:()=>s(p),handleClickDownload:n,manuallyCreated:!1,objectLastModified:p.last_modified||"",objectSize:p.size||0},p.name))),c?e.jsx(J,{columns:4,responsive:{2:{mdDown:!0}}}):null]})},At=C.memo(Nt),aa=()=>{const t=Me("/object-storage/buckets/:clusterId/:bucketName"),r=Re(),d=ze(),{enqueueSnackbar:m}=$e(),s=(t==null?void 0:t.params.bucketName)||"",n=(t==null?void 0:t.params.clusterId)||"",a=We(r.search,"prefix"),c=_e(),{data:o,error:h,fetchNextPage:x,hasNextPage:f,isFetching:D,isFetchingNextPage:p,isLoading:I}=Ue(n,s,a),[P,v]=C.useState(!1),[w,me]=C.useState(),[ue,N]=C.useState(),[pe,M]=C.useState(!1),[j,he]=C.useState(),[xe,_]=C.useState(!1),[be,A]=C.useState(!1),je=async l=>{try{const{url:u}=await q(n,s,l,"GET",{content_disposition:"attachment"});qe(),window.location.assign(u)}catch{m("Error downloading Object",{variant:"error"})}},fe=l=>{me(l),N(void 0),M(!0)},ye=l=>{he(l),_(!0)},ge=Qe(3e3,!1,()=>Ge(n,s,c)),Ce=async()=>{if(w){if(A(!0),N(void 0),w.endsWith("/")&&(await Ke(n,s,{delimiter:Ve,prefix:w})).data.filter(i=>!oe(i)&&!w.endsWith(i.name)).length>0){A(!1),N("The folder must be empty to delete it.");return}try{const{url:l}=await q(n,s,w,"DELETE");await at(l),ge(),A(!1),M(!1),De(w)}catch{A(!1),N("Unable to delete object.")}}},E=l=>{c.setQueryData([G,n,s,"objects",...Je(a)],u=>({pageParams:(u==null?void 0:u.pageParams)||[],pages:l}))},De=l=>{const u=Xe(o==null?void 0:o.pages,i=>{let g=-1;const k=i==null?void 0:i.findIndex(S=>{const O=S.data.findIndex(F=>F.name===l);return g=O!==-1?O:-1,O!==-1});return i&&k!==void 0&&k!==-1&&i[k].data.splice(g,1),i});E(u??[])},U=(l,u)=>{const i=rt(a,l);i&&(i.type==="FILE"?Se(i.name,u):we(i.name))},Se=(l,u)=>{if(!o)return;const i={etag:"",last_modified:new Date().toISOString(),name:a+l,owner:"",size:u};for(let S=0;S<o.pages.length;S++){const O=o.pages[S].data.findIndex(F=>F.name===i.name);if(O!==-1){const F=[...o.pages],H=[...o.pages[S].data];H[O]=i,F[S].data=H,E(F);return}}const g=[...o.pages],k=[...g[g.length-1].data];k.push(i),g[g.length-1].data=k,E(g)},we=l=>{if(!o)return;const u={etag:null,last_modified:null,name:`${a+l}/`,owner:null,size:null};for(const k of o.pages)if(k.data.find(S=>S.name===u.name)){c.invalidateQueries([G,n,s,...`${a}${l}`.split("/")]);return}const i=[...o.pages],g=[...i[i.length-1].data];g.push(u),i[i.length-1].data=g,E(i)},Q=()=>{M(!1)},ke=()=>{_(!1)},R=(o==null?void 0:o.pages.map(l=>l.data.length).reduce((l,u)=>l+u,0))||0;return!s||!n?null:e.jsxs(e.Fragment,{children:[e.jsx(xt,{bucketName:s,history:d,prefix:a}),e.jsx(tt,{bucketName:s,clusterId:n,maybeAddObjectToTable:U,prefix:a}),e.jsx(se,{display:"flex",justifyContent:"flex-end",mb:.5,mt:1.5,children:e.jsx(yt,{buttonType:"outlined",onClick:()=>v(!0),children:"Create Folder"})}),e.jsxs(Ze,{"aria-label":"List of Bucket Objects",children:[e.jsx(mt,{children:e.jsxs(W,{children:[e.jsx(bt,{children:"Object"}),e.jsx(jt,{children:"Size"}),e.jsx($,{mdDown:!0,children:e.jsx(y,{children:"Last Modified"})}),e.jsx(y,{})]})}),e.jsx(et,{children:e.jsx(At,{data:(o==null?void 0:o.pages)||[],error:h||void 0,handleClickDelete:fe,handleClickDetails:ye,handleClickDownload:je,isFetching:D,isFetchingNextPage:p,numOfDisplayedObjects:R,prefix:a})})]}),!I&&!p&&!h&&f&&e.jsx(Ye,{onEnter:()=>x(),children:e.jsx("div",{})}),h&&e.jsxs(gt,{variant:"subtitle2",children:["The next objects in the list failed to load."," ",e.jsx(ft,{onClick:()=>x(),children:"Click here to try again."})]}),!f&&R>=100&&e.jsxs(Ct,{variant:"subtitle2",children:["Showing all ",R," items"]}),e.jsx(He,{actions:()=>e.jsx(Z,{primaryButtonProps:{"data-testid":"submit-rebuild",label:"Delete",loading:be,onClick:Ce},secondaryButtonProps:{"data-testid":"cancel",label:"Cancel",onClick:Q}}),title:w?`Delete ${B(z(w))}`:"Delete object",error:ue,onClose:Q,open:pe,children:"Are you sure you want to delete this object?"}),e.jsx(St,{url:j?ot(n,s,j.name).absolute:void 0,bucketName:s,clusterId:n,displayName:j==null?void 0:j.name,lastModified:j==null?void 0:j.last_modified,name:j==null?void 0:j.name,onClose:ke,open:xe,size:j==null?void 0:j.size}),e.jsx(Dt,{bucketName:s,clusterId:n,maybeAddObjectToTable:U,onClose:()=>v(!1),open:P,prefix:a})]})};export{aa as BucketDetail};
