import{m as E,r as n,j as e,ad as k,T as D,ag as L,km as R,af as N}from"./index-Eksrs3uK.js";import{A as M}from"./AddNewLink-LwviGK8c.js";import{I as _}from"./InlineMenuAction-d5mRENST.js";import{b as F,c as O,T as $,a as W}from"./TableRow-phXfWUGW.js";import{i as z,e as U,v as V,s as q}from"./ipUtils-P4y3JNCT.js";import{u as G}from"./formik.esm-Kap5lsIh.js";import{D as H}from"./Drawer-A9yKjC3Z.js";import{M as J}from"./MultipleIPInput-NQt3M-F3.js";import{e as K}from"./FirewallRuleDrawer.utils-gE7QU4cL.js";import{b as Q}from"./formikErrorUtils-jhqfCjwU.js";const X=E()(a=>({instructions:{marginBottom:"2rem"},ipSelect:{marginTop:a.spacing(2)}})),Y=a=>{const{allowList:i,onClose:u,open:p,updateDatabase:P}=a,{classes:o}=X(),[A,f]=n.useState(""),[h,b]=n.useState(),[c,T]=n.useState(!1),I=t=>{const l=K(t);d({_allowList:l})},C=({_allowList:t},{setFieldError:l,setSubmitting:s})=>{const r=t.reduce((w,j)=>{let m=U(j);return m===""?w:(m.indexOf("/")===-1&&(m+="/32"),[...w,m])},[]);P({allow_list:[...r]}).then(()=>{s(!1),u()}).catch(w=>{const j=w.filter(m=>m.field==="allow_list");j&&b(j),Q(w,l,f),s(!1)})},y=({_allowList:t})=>{const l=V(t,{allowEmptyAddress:!1,errorMessage:"Must be a valid IPv4 address."});d({_allowList:l});const s=l.filter(r=>!!r.error);return s.length===0?{}:{_allowList:s}},{handleSubmit:v,isSubmitting:S,resetForm:x,setValues:d,values:g}=G({enableReinitialize:!0,initialValues:{_allowList:i},onSubmit:C,validate:t=>y(t),validateOnBlur:!1,validateOnChange:!1}),B=n.useCallback(t=>{c||T(!0),d({_allowList:t})},[c,d]);return n.useEffect(()=>{p&&(f(""),b([]),x())},[p,x]),e.jsx(H,{onClose:u,open:p,title:"Manage Access Controls",children:e.jsxs(n.Fragment,{children:[A?e.jsx(k,{text:A,variant:"error"}):null,h?h.map(t=>e.jsx(k,{text:t.reason,variant:"error"},t.reason)):null,e.jsx(D,{className:o.instructions,variant:"body1",children:"Add, edit, or remove IPv4 addresses and ranges that should be authorized to access your cluster."}),e.jsxs("form",{onSubmit:v,children:[e.jsx(J,{"aria-label":"Allowed IP Addresses or Ranges",className:o.ipSelect,forDatabaseAccessControls:!0,inputProps:{autoFocus:!0},ips:g._allowList,onBlur:I,onChange:B,placeholder:z,title:"Allowed IP Address(es) or Range(s)"}),e.jsx(L,{primaryButtonProps:{disabled:!c,label:"Update Access Controls",loading:S,type:"submit"},secondaryButtonProps:{label:"Cancel",onClick:u}})]})]})})},Z=E()(a=>({addAccessControlBtn:{minWidth:225,[a.breakpoints.down("md")]:{alignSelf:"flex-start",marginBottom:"1rem"}},cell:{alignItems:"center",borderBottom:`solid 1px ${a.borderColors.borderTable}`,display:"flex",justifyContent:"space-between"},removeButton:{float:"right"},restrictWarning:{width:"50%"},restrictWarningText:{fontSize:"0.875rem,"},row:{"&:last-of-type td":{borderBottom:"none"}},sectionText:{marginBottom:"1rem",marginRight:0,[a.breakpoints.down("sm")]:{width:"100%"},width:"65%"},sectionTitle:{marginBottom:"0.25rem"},sectionTitleAndText:{width:"100%"},table:{border:`solid 1px ${a.borderColors.borderTable}`,[a.breakpoints.down("sm")]:{width:"100%"},width:"50%"},topSection:{alignItems:"center",display:"flex",justifyContent:"space-between",[a.breakpoints.down("md")]:{flexDirection:"column"}}})),de=a=>{const{database:{allow_list:i,engine:u,id:p},description:P}=a,{classes:o}=Z(),[A,f]=n.useState(!1),[h,b]=n.useState(),[c,T]=n.useState(null),[I,C]=n.useState(!1),[y,v]=n.useState([]),{isLoading:S,mutateAsync:x}=R(u,p);n.useEffect(()=>{if(i.length>0){const s=i.map(q);v(s)}else v([])},[i]);const d=s=>{b(void 0),f(!0),T(s)},g=()=>{f(!1)},B=()=>{x({allow_list:i.filter(s=>s!==c)}).then(()=>{g()}).catch(s=>{b(s[0].reason)})},t=s=>s.length===0?null:e.jsx(F,{className:o.table,"data-qa-access-controls":!0,children:e.jsx(O,{children:s.map(r=>e.jsx($,{className:o.row,children:e.jsxs(W,{className:o.cell,children:[r,e.jsx(_,{actionText:"Remove",className:o.removeButton,onClick:()=>d(r)})]},`${r}-tablecell`)},`${r}-row`))})}),l=e.jsx(L,{primaryButtonProps:{label:"Remove IP Address",loading:S,onClick:B},secondaryButtonProps:{label:"Cancel",onClick:g}});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:o.topSection,children:[e.jsxs("div",{className:o.sectionTitleAndText,children:[e.jsx("div",{className:o.sectionTitle,children:e.jsx(D,{variant:"h3",children:"Access Controls"})}),e.jsx("div",{className:o.sectionText,children:P??null})]}),e.jsx(M,{className:o.addAccessControlBtn,label:"Manage Access Controls",onClick:()=>C(!0)})]}),t(i),e.jsxs(N,{actions:l,onClose:g,open:A,title:`Remove IP Address ${c}`,children:[h?e.jsx(k,{text:h,variant:"error"}):null,e.jsxs(D,{"data-testid":"ip-removal-confirmation-warning",children:["IP ",c," will lose all access to the data on this database cluster. This action cannot be undone, but you can re-enable access by clicking Manage Access Controls and adding the same IP address."]})]}),e.jsx(Y,{allowList:y,onClose:()=>C(!1),open:I,updateDatabase:x})]})};export{de as A};
